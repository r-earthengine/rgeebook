<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>ImageCollection | Earth Engine with R</title>
<meta name="author" content="rgee team">
<meta name="generator" content="bookdown 0.25.2 with bs4_book()">
<meta property="og:title" content="ImageCollection | Earth Engine with R">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ImageCollection | Earth Engine with R">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1.9000/transition.js"></script><script src="libs/bs3compat-0.3.1.9000/tabs.js"></script><script src="libs/bs3compat-0.3.1.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141212623-1"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-141212623-1');
  </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<meta name="description" content="This section requires the next libraries: library(rgee) library(rgeeExtra) ee_Initialize() ImageCollection Overview An ImageCollection is a stack or sequence of images. An ImageCollection can be...">
<meta property="og:description" content="This section requires the next libraries: library(rgee) library(rgeeExtra) ee_Initialize() ImageCollection Overview An ImageCollection is a stack or sequence of images. An ImageCollection can be...">
<meta name="twitter:description" content="This section requires the next libraries: library(rgee) library(rgeeExtra) ee_Initialize() ImageCollection Overview An ImageCollection is a stack or sequence of images. An ImageCollection can be...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Earth Engine with R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="earthengine-examples.html">earthengine-examples</a></li>
<li><a class="" href="rgee-cheatsheet.html">rgee-cheatsheet</a></li>
<li class="book-part">R Guides</li>
<li><a class="" href="overview.html">Overview</a></li>
<li><a class="" href="rgeeextra.html">rgeeExtra</a></li>
<li><a class="" href="visualization.html">Visualization</a></li>
<li class="book-part">Get Started</li>
<li><a class="" href="r-quickstart.html">R Quickstart</a></li>
<li><a class="" href="coding-best-practices.html">Coding Best Practices</a></li>
<li><a class="" href="debugging.html">Debugging</a></li>
<li class="book-part">Development Environments</li>
<li><a class="" href="earth-engine-in-rstudio.html">Earth Engine in Rstudio</a></li>
<li><a class="" href="r-and-python-requirements.html">R and Python requirements</a></li>
<li><a class="" href="sync-gcs-and-rgee.html">sync GCS and rgee</a></li>
<li><a class="" href="integrate-rmarkdown-and-rgee.html">Integrate Rmarkdown and rgee</a></li>
<li><a class="" href="deploy-rgee-shiny-apps.html">Deploy rgee Shiny apps</a></li>
<li><a class="" href="comparing-rgee-vs-python-and-javascript.html">Comparing rgee vs Python and Javascript</a></li>
<li><a class="" href="extra-considerations.html">Extra considerations</a></li>
<li class="book-part">API Tutorials</li>
<li><a class="" href="overview-1.html">Overview</a></li>
<li><a class="" href="introduction-to-r-for-earth-engine.html">Introduction to R for Earth Engine</a></li>
<li><a class="" href="the-earth-engine-api.html">The Earth Engine API</a></li>
<li><a class="" href="global-forest-change.html">Global Forest Change</a></li>
<li><a class="" href="global-surface-water.html">Global Surface Water</a></li>
<li><a class="" href="video-tutorials-1.html">Video Tutorials</a></li>
<li class="book-part">Concepts</li>
<li><a class="" href="how-earth-engine-works.html">How Earth Engine works</a></li>
<li><a class="" href="client-vs-server.html">Client vs Server</a></li>
<li><a class="" href="deferred-exacution.html">Deferred exacution</a></li>
<li><a class="" href="scale.html">Scale</a></li>
<li><a class="" href="projections.html">Projections</a></li>
<li class="book-part">Objects and Methods</li>
<li><a class="" href="objects-and-methods-overview.html">Objects and Methods Overview</a></li>
<li><a class="" href="image.html">Image</a></li>
<li><a class="active" href="imagecollection.html">ImageCollection</a></li>
<li><a class="" href="geometry.html">Geometry</a></li>
<li><a class="" href="feature-featurecollection.html">Feature &amp; FeatureCollection</a></li>
<li><a class="" href="reducer.html">Reducer</a></li>
<li><a class="" href="join.html">Join</a></li>
<li><a class="" href="array.html">Array</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/r-earthengine/rgeebook">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="imagecollection" class="section level1 unnumbered">
<h1>ImageCollection<a class="anchor" aria-label="anchor" href="#imagecollection"><i class="fas fa-link"></i></a>
</h1>
<p>This section requires the next libraries:</p>
<div class="sourceCode" id="cb342"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/rgee/">rgee</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">rgeeExtra</span><span class="op">)</span>

<span class="fu">ee_Initialize</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div id="imagecollection-overview" class="section level2 unnumbered">
<h2>ImageCollection Overview<a class="anchor" aria-label="anchor" href="#imagecollection-overview"><i class="fas fa-link"></i></a>
</h2>
<p>An <code>ImageCollection</code> is a stack or sequence of images. An <code>ImageCollection</code> can be loaded by pasting an Earth Engine asset ID into the <code>ImageCollection</code> constructor. You can find <code>ImageCollection</code> IDs in the <a href="https:#developers.google.com/earth-engine/datasets">data catalog</a>. For example, to load the <a href="https:#developers.google.com/earth-engine/guides/datasets/catalog/COPERNICUS_S2_SR">Sentinel-2 surface reflectance collection</a>:</p>
<div class="sourceCode" id="cb343"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sentinelCollection</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"COPERNICUS/S2_SR"</span><span class="op">)</span></code></pre></div>
<p>This collection contains every Sentinel-2 image in the public catalog. There are a lot. Usually you want to filter the collection as shown <a href="https:#developers.google.com/earth-engine/guides/ic_info">here</a> or <a href="https:#developers.google.com/earth-engine/guides/ic_filtering">here</a>.</p>
<p>In addition to loading an <code>ImageCollection</code> using an Earth Engine collection ID, Earth Engine has methods to create image collections. The constructor <code>ee$ImageCollection()</code> or the convenience method <code>ee$ImageCollection$fromImages()</code> create image collections from lists of images. You can also create new image collections by merging existing collections. For example:</p>
<div class="sourceCode" id="cb344"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create arbitrary constant images.</span>
<span class="va">constant1</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">constant2</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>

<span class="co"># Create a collection by giving a list to the constructor.</span>
<span class="va">collectionFromConstructor</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">constant1</span>, <span class="va">constant2</span><span class="op">)</span><span class="op">)</span>
<span class="fu">ee_print</span><span class="op">(</span><span class="va">collectionFromConstructor</span><span class="op">)</span>

<span class="co"># Create a collection with fromImages().</span>
<span class="va">collectionFromImages</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">fromImages</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu">ee_print</span><span class="op">(</span><span class="va">collectionFromConstructor</span><span class="op">)</span>

<span class="co"># Merge two collections.</span>
<span class="va">mergedCollection</span> <span class="op">&lt;-</span> <span class="va">collectionFromConstructor</span><span class="op">$</span><span class="fu">merge</span><span class="op">(</span><span class="va">collectionFromImages</span><span class="op">)</span>
<span class="fu">ee_print</span><span class="op">(</span><span class="va">mergedCollection</span><span class="op">)</span>

<span class="co"># Create a toy FeatureCollection.</span>
<span class="va">features</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">FeatureCollection</span><span class="op">(</span>
  <span class="va">ee</span><span class="op">$</span><span class="fu">Feature</span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
  <span class="va">ee</span><span class="op">$</span><span class="fu">Feature</span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Create an ImageCollection from the FeatureCollection</span>
<span class="co"># by mapping a function over the FeatureCollection.</span>
<span class="va">images</span> <span class="op">&lt;-</span> <span class="va">features</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">feature</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="fu">Number</span><span class="op">(</span><span class="va">feature</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"foo"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Print the resultant collection.</span>
<span class="fu">ee_print</span><span class="op">(</span><span class="va">images</span><span class="op">)</span></code></pre></div>
<p>Note that in this example an <code>ImageCollection</code> is created by mapping a function that returns an <code>Image</code> over a <code>FeatureCollection</code>. Learn more about mapping in the <a href="">Mapping over an ImageCollection section</a>. Learn more about feature collections from the <a href="">FeatureCollection section</a>.</p>
<p>You can also create an <code>ImageCollection</code> from GeoTiffs in Cloud Storage. For example:</p>
<div class="sourceCode" id="cb345"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># All the GeoTiffs are in this folder.</span>
<span class="va">uriBase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="st">"gs://gcp-public-data-landsat/LC08/01/001/002/"</span>, <span class="st">"LC08_L1GT_001002_20160817_20170322_01_T2/"</span>
<span class="op">)</span>

<span class="co"># List of URIs, one for each band.</span>
<span class="va">uris</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">List</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">uriBase</span>, <span class="st">"LC08_L1GT_001002_20160817_20170322_01_T2_B2.TIF"</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">uriBase</span>, <span class="st">"LC08_L1GT_001002_20160817_20170322_01_T2_B3.TIF"</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">uriBase</span>, <span class="st">"LC08_L1GT_001002_20160817_20170322_01_T2_B4.TIF"</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">uriBase</span>, <span class="st">"LC08_L1GT_001002_20160817_20170322_01_T2_B5.TIF"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="co"># Make a collection from the list of images.</span>
<span class="va">images</span> <span class="op">&lt;-</span> <span class="va">uris</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="fu">ee_utils_pyfunc</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">ee</span><span class="op">$</span><span class="va">Image</span><span class="op">$</span><span class="fu">loadGeoTIFF</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">collection</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="va">images</span><span class="op">)</span>

<span class="co"># Get an RGB image from the collection of bands.</span>
<span class="va">rgb</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">toBands</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">rename</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B2"</span>, <span class="st">"B3"</span>, <span class="st">"B4"</span>, <span class="st">"B5"</span><span class="op">)</span><span class="op">)</span>

<span class="va">Map</span><span class="op">$</span><span class="fu">centerObject</span><span class="op">(</span><span class="va">rgb</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">rgb</span>,
  <span class="va">vizParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B4"</span>, <span class="st">"B3"</span>, <span class="st">"B2"</span><span class="op">)</span>,
    min <span class="op">=</span> <span class="fl">0</span>,
    max <span class="op">=</span> <span class="fl">20000</span>
  <span class="op">)</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"rgb"</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/chapter_05/figure_ico.png" width="670" alt=""><p class="caption">Figure 1. <code>ImageCollection</code> from GeoTiffs in Cloud Storage</p>
</div>
<p><a href="">Learn more about loading images from Cloud GeoTiffs</a></p>
</div>
<div id="imagecollection-visualization" class="section level2 unnumbered">
<h2>ImageCollection Visualization<a class="anchor" aria-label="anchor" href="#imagecollection-visualization"><i class="fas fa-link"></i></a>
</h2>
<p>Images composing an <code>ImageCollection</code> can be visualized as either an animation or a series of thumbnails referred to as a “filmstrip”. These methods provide a quick assessment of the contents of an <code>ImageCollection</code> and an effective medium for witnessing spatiotemporal change (Figure 2).</p>
<ul>
<li>
<a href="">getVideoThumbURL()</a> produces an animated image series</li>
<li>
<a href="">getFilmstripThumbURL()</a> produces a thumbnail image series</li>
</ul>
<p>The following sections describe how to prepare an <code>ImageCollection</code> for visualization, provide example code for each collection visualization method, and cover several advanced animation techniques.</p>
<div class="figure">
<img src="../images/gif/chapter_05/gif_01.gif" width="670" alt=""><p class="caption">Figure 2. Animation showing a three-day progression of Atlantic hurricanes in September, 2017.</p>
</div>
<div id="collection-preparation" class="section level3 unnumbered">
<h3>Collection preparation<a class="anchor" aria-label="anchor" href="#collection-preparation"><i class="fas fa-link"></i></a>
</h3>
<p>Filter, composite, sort, and style images within a collection to display only those of interest or emphasize a phenomenon. Any <code>ImageCollection</code> can be provided as input to the visualization functions, but a curated collection with consideration of inter- and intra-annual date ranges, observation interval, regional extent, quality and representation can achieve better results.</p>
<div id="filtering" class="section level4 unnumbered">
<h4>Filtering<a class="anchor" aria-label="anchor" href="#filtering"><i class="fas fa-link"></i></a>
</h4>
<p>Filter an image collection to include only relevant data that supports the purpose of the visualization. Consider dates, spatial extent, quality, and other properties specific to a given dataset.</p>
<p>For instance, filter a Sentinel-2 surface reflectance collection by:</p>
<p>a single date range,</p>
<div class="sourceCode" id="cb346"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s2col</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"COPERNICUS/S2_SR"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2018-01-01"</span>, <span class="st">"2019-01-01"</span><span class="op">)</span></code></pre></div>
<p>a serial day-of-year range,</p>
<div class="sourceCode" id="cb347"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s2col</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"COPERNICUS/S2_SR"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">calendarRange</span><span class="op">(</span><span class="fl">171</span>, <span class="fl">242</span>, <span class="st">"day_of_year"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>a region of interest,</p>
<div class="sourceCode" id="cb348"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ee_geom</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="op">-</span><span class="fl">122.1</span>, <span class="fl">37.2</span><span class="op">)</span>
<span class="va">s2col</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"COPERNICUS/S2_SR"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">ee_geom</span><span class="op">)</span></code></pre></div>
<p>or an image property.</p>
<div class="sourceCode" id="cb349"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s2col</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"COPERNICUS/S2_SR"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">lt</span><span class="op">(</span><span class="st">"CLOUDY_PIXEL_PERCENTAGE"</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Chain multiple filters.</p>
<div class="sourceCode" id="cb350"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ee_geom</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="op">-</span><span class="fl">122.1</span>, <span class="fl">37.2</span><span class="op">)</span>
<span class="va">s2col</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"COPERNICUS/S2_SR"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2018-01-01"</span>, <span class="st">"2019-01-01"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">ee_geom</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="st">"CLOUDY_PIXEL_PERCENTAGE &lt; 50"</span><span class="op">)</span></code></pre></div>
</div>
<div id="compositing" class="section level4 unnumbered">
<h4>Compositing<a class="anchor" aria-label="anchor" href="#compositing"><i class="fas fa-link"></i></a>
</h4>
<p>Composite intra- and inter-annual date ranges to reduce the number of images in a collection and improve quality. For example, suppose you were to create a visualization of annual NDVI for Africa. One option is to simply filter a MODIS 16-day NDVI collection to include all 2018 observations.</p>
<div class="sourceCode" id="cb351"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ndviCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"MODIS/006/MOD13A2"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2018-01-01"</span>, <span class="st">"2019-01-01"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"NDVI"</span><span class="op">)</span></code></pre></div>
<div id="inter-annual-composite-by-filter-and-reduce" class="section level5 unnumbered">
<h5>
<strong>Inter-annual composite by filter and reduce</strong><a class="anchor" aria-label="anchor" href="#inter-annual-composite-by-filter-and-reduce"><i class="fas fa-link"></i></a>
</h5>
<p>Visualization of the above collection shows considerable noise in the forested regions where cloud cover is heavy (Figure 3a). A better representation can be achieved by reducing serial date ranges by median across all years in the MODIS collection.</p>
<div class="sourceCode" id="cb352"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make a day-of-year sequence from 1 to 365 with a 16-day step.</span>
<span class="va">doyList</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">List</span><span class="op">$</span><span class="fu">sequence</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">365</span>, <span class="fl">16</span><span class="op">)</span>

<span class="co"># Import a MODIS NDVI collection.</span>
<span class="va">ndviCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"MODIS/006/MOD13A2"</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"NDVI"</span><span class="op">)</span>

<span class="co"># Map over the list of days to build a list of image composites.</span>
<span class="va">map_over_days</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">startDoy</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Ensure that startDoy is a number.</span>
  <span class="va">startDoy</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Number</span><span class="op">(</span><span class="va">startDoy</span><span class="op">)</span>

  <span class="co"># Filter images by date range; starting with the current startDate and</span>
  <span class="co"># ending 15 days later. Reduce the resulting image collection by median.</span>
  <span class="va">ndviCol</span> <span class="op">%&gt;%</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span>
      <span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">calendarRange</span><span class="op">(</span><span class="va">startDoy</span>, <span class="va">startDoy</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="fl">15</span><span class="op">)</span>, <span class="st">"day_of_year"</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">reduce</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">median</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">ndviCompList</span> <span class="op">&lt;-</span> <span class="va">doyList</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="fu">ee_utils_pyfunc</span><span class="op">(</span><span class="va">map_over_days</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Convert the image List to an ImageCollection.</span>
<span class="va">ndviCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">fromImages</span><span class="op">(</span><span class="va">ndviCompList</span><span class="op">)</span></code></pre></div>
<p>The animation resulting from this collection is less noisy, as each image represents the median of a 16-day NDVI composite for 20+ years of data (Figure 3b). See <a href="">this tutorial</a> for more information on this animation.</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th align="left"><img src="../images/gif/chapter_05/gif_02_1.gif" width="335"></th>
<th align="left"><img src="../images/gif/chapter_05/gif_02_2.gif" width="335"></th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">Figure 3a. Annual NDVI <em>without</em> inter-annual compositing.</td>
<td align="left">Figure 3b. Annual NDVI <em>with</em> inter-annual compositing.</td>
</tr></tbody>
</table></div>
</div>
<div id="intra-annual-composite-by-filter-and-reduce" class="section level5 unnumbered">
<h5>
<strong>Intra-annual composite by filter and reduce</strong><a class="anchor" aria-label="anchor" href="#intra-annual-composite-by-filter-and-reduce"><i class="fas fa-link"></i></a>
</h5>
<p>The previous example applies inter-annual compositing. It can also be helpful to composite a series of intra-annual observations. For example, Landsat data are collected every sixteen days for a given scene per sensor, but often some portion of the images are obscured by clouds. Masking out the clouds and compositing several images from the same season can produce a more cloud-free representation. Consider the following example where Landsat 5 images from July and August are composited using median for each year from 1985 to 2011.</p>
<div class="sourceCode" id="cb353"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make a day-of-year sequence from 1 to 365 with a 16-day step.</span>
<span class="va">doyList</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">List</span><span class="op">$</span><span class="fu">sequence</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">365</span>, <span class="fl">16</span><span class="op">)</span>

<span class="co"># Import a MODIS NDVI collection.</span>
<span class="va">ndviCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"MODIS/006/MOD13A2"</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"NDVI"</span><span class="op">)</span>

<span class="co"># Map over the list of days to build a list of image composites.</span>
<span class="va">map_over_days</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">startDoy</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Ensure that startDoy is a number.</span>
  <span class="va">startDoy</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Number</span><span class="op">(</span><span class="va">startDoy</span><span class="op">)</span>

  <span class="co"># Filter images by date range; starting with the current startDate and</span>
  <span class="co"># ending 15 days later. Reduce the resulting image collection by median.</span>
  <span class="va">ndviCol</span> <span class="op">%&gt;%</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span>
      <span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">calendarRange</span><span class="op">(</span><span class="va">startDoy</span>, <span class="va">startDoy</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="fl">15</span><span class="op">)</span>, <span class="st">"day_of_year"</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">reduce</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">median</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">ndviCompList</span> <span class="op">&lt;-</span> <span class="va">doyList</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="fu">ee_utils_pyfunc</span><span class="op">(</span><span class="va">map_over_days</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Convert the image List to an ImageCollection.</span>
<span class="va">ndviCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">fromImages</span><span class="op">(</span><span class="va">ndviCompList</span><span class="op">)</span>

<span class="co"># Assemble a collection of Landsat surface reflectance images for a given</span>
<span class="co"># region and day-of-year range.</span>
<span class="va">ee_geom</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="op">-</span><span class="fl">122.9</span>, <span class="fl">43.6</span><span class="op">)</span>
<span class="va">lsCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"LANDSAT/LT05/C02/T1_L2"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">ee_geom</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">dayOfYear</span><span class="op">(</span><span class="fl">182</span>, <span class="fl">243</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Add the observation year as a property to each image.</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">img</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"year"</span>, <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="va">img</span><span class="op">)</span><span class="op">$</span><span class="fu">date</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

<span class="co"># Define a function to scale the data and mask unwanted pixels.</span>
<span class="va">maskL457sr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">image</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Bit 0 - Fill</span>
  <span class="co"># Bit 1 - Dilated Cloud</span>
  <span class="co"># Bit 2 - Unused</span>
  <span class="co"># Bit 3 - Cloud</span>
  <span class="co"># Bit 4 - Cloud Shadow</span>
  <span class="va">qaMask</span> <span class="op">&lt;-</span> <span class="va">image</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"QA_PIXEL"</span><span class="op">)</span><span class="op">$</span><span class="fu">bitwiseAnd</span><span class="op">(</span><span class="fl">31</span><span class="op">)</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
  <span class="va">saturationMask</span> <span class="op">&lt;-</span> <span class="va">image</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"QA_RADSAT"</span><span class="op">)</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>

  <span class="co"># Apply the scaling factors to the appropriate bands.</span>
  <span class="va">opticalBands</span> <span class="op">&lt;-</span> <span class="va">image</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"SR_B."</span><span class="op">)</span><span class="op">$</span><span class="fu">multiply</span><span class="op">(</span><span class="fl">0.0000275</span><span class="op">)</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span><span class="op">)</span>
  <span class="va">thermalBand</span> <span class="op">&lt;-</span> <span class="va">image</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"ST_B6"</span><span class="op">)</span><span class="op">$</span><span class="fu">multiply</span><span class="op">(</span><span class="fl">0.00341802</span><span class="op">)</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="fl">149.0</span><span class="op">)</span>

  <span class="co"># Replace the original bands with the scaled ones and apply the masks.</span>
  <span class="va">image</span> <span class="op">%&gt;%</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">Image</span><span class="op">$</span><span class="fu">addBands</span><span class="op">(</span><span class="va">opticalBands</span>, <span class="cn">NULL</span>, <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">Image</span><span class="op">$</span><span class="fu">addBands</span><span class="op">(</span><span class="va">thermalBand</span>, <span class="cn">NULL</span>, <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">Image</span><span class="op">$</span><span class="fu">updateMask</span><span class="op">(</span><span class="va">qaMask</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">Image</span><span class="op">$</span><span class="fu">updateMask</span><span class="op">(</span><span class="va">saturationMask</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Define a list of unique observation years from the image collection.</span>
<span class="va">years</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">List</span><span class="op">(</span><span class="va">lsCol</span><span class="op">$</span><span class="fu">aggregate_array</span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">distinct</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">sort</span><span class="op">(</span><span class="op">)</span>

<span class="co"># Map over the list of years to build a list of annual image composites.</span>
<span class="va">map_over_year</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">lsCol</span> <span class="op">%&gt;%</span>
    <span class="co"># Filter image collection by year.</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterMetadata</span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"equals"</span>, <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co"># Apply cloud mask.</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="va">maskL457sr</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co"># Reduce image collection by median.</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">reduce</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">median</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co"># Set composite year as an image property.</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">Image</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"year"</span>, <span class="va">year</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">lsCompList</span> <span class="op">&lt;-</span> <span class="va">years</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="fu">ee_utils_pyfunc</span><span class="op">(</span><span class="va">map_over_year</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Convert the image List to an ImageCollection.</span>
<span class="va">lsCompCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">fromImages</span><span class="op">(</span><span class="va">lsCompList</span><span class="op">)</span></code></pre></div>
</div>
<div id="intra-annual-composite-by-join-and-reduce" class="section level5 unnumbered">
<h5>
<strong>Intra-annual composite by join and reduce</strong><a class="anchor" aria-label="anchor" href="#intra-annual-composite-by-join-and-reduce"><i class="fas fa-link"></i></a>
</h5>
<p>Note that the previous two compositing methods map over a <code>List</code> of days and years to incrementally define new dates to filter and composite over. Applying a join is another method for achieving this operation. In the following snippet, a unique year collection is defined and then a <code>saveAll</code> join is applied to identify all images that correspond to a given year. Images belonging to a given year are grouped into a <code>List</code> object which is stored as a property of the respective year representative in the distinct year collection. Annual composites are generated from these lists by reducing <code>ImageCollections</code> defined by them in a function mapped over the distinct year collection.</p>
<div class="sourceCode" id="cb354"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Assemble a collection of Landsat surface reflectance images for a given</span>
<span class="co"># region and day-of-year range.</span>
<span class="va">ee_geom</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="op">-</span><span class="fl">122.9</span>, <span class="fl">43.6</span><span class="op">)</span>
<span class="va">lsCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"LANDSAT/LT05/C02/T1_L2"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">ee_geom</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">dayOfYear</span><span class="op">(</span><span class="fl">182</span>, <span class="fl">243</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Add the observation year as a property to each image.</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">img</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"year"</span>, <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="va">img</span><span class="op">)</span><span class="op">$</span><span class="fu">date</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

<span class="co"># Make a distinct year collection; one image representative per year.</span>
<span class="va">distinctYears</span> <span class="op">&lt;-</span> <span class="va">lsCol</span><span class="op">$</span><span class="fu">distinct</span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span><span class="op">$</span><span class="fu">sort</span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span>

<span class="co"># Define a join filter; one-to-many join on ‘year’ property.</span>
<span class="va">filter</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">equals</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">leftField</span> <span class="op">&lt;-</span> <span class="st">"year"</span>, <span class="va">rightField</span> <span class="op">&lt;-</span> <span class="st">"year"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Define a join.</span>
<span class="va">join</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Join</span><span class="op">$</span><span class="fu">saveAll</span><span class="op">(</span><span class="st">"year_match"</span><span class="op">)</span>

<span class="co"># Apply the join; results in 'year_match' property being added to each distinct</span>
<span class="co"># year representative image. The list includes all images in the collection</span>
<span class="co"># belonging to the respective year.</span>
<span class="va">joinCol</span> <span class="op">&lt;-</span> <span class="va">join</span><span class="op">$</span><span class="fu">apply</span><span class="op">(</span><span class="va">distinctYears</span>, <span class="va">lsCol</span>, <span class="va">filter</span><span class="op">)</span>

<span class="co"># Define a function to scale the data and mask unwanted pixels.</span>
<span class="va">maskL457sr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">image</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Bit 0 - Fill</span>
  <span class="co"># Bit 1 - Dilated Cloud</span>
  <span class="co"># Bit 2 - Unused</span>
  <span class="co"># Bit 3 - Cloud</span>
  <span class="co"># Bit 4 - Cloud Shadow</span>
  <span class="va">qaMask</span> <span class="op">&lt;-</span> <span class="va">image</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"QA_PIXEL"</span><span class="op">)</span><span class="op">$</span><span class="fu">bitwiseAnd</span><span class="op">(</span><span class="fl">31</span><span class="op">)</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
  <span class="va">saturationMask</span> <span class="op">&lt;-</span> <span class="va">image</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"QA_RADSAT"</span><span class="op">)</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>

  <span class="co"># Apply the scaling factors to the appropriate bands.</span>
  <span class="va">opticalBands</span> <span class="op">&lt;-</span> <span class="va">image</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"SR_B."</span><span class="op">)</span><span class="op">$</span><span class="fu">multiply</span><span class="op">(</span><span class="fl">0.0000275</span><span class="op">)</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span><span class="op">)</span>
  <span class="va">thermalBand</span> <span class="op">&lt;-</span> <span class="va">image</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"ST_B6"</span><span class="op">)</span><span class="op">$</span><span class="fu">multiply</span><span class="op">(</span><span class="fl">0.00341802</span><span class="op">)</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="fl">149.0</span><span class="op">)</span>

  <span class="co"># Replace the original bands with the scaled ones and apply the masks.</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">image</span><span class="op">$</span><span class="fu">addBands</span><span class="op">(</span><span class="va">opticalBands</span>, <span class="cn">NULL</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span>
    <span class="fu">addBands</span><span class="op">(</span><span class="va">thermalBand</span>, <span class="cn">NULL</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span>
    <span class="fu">updateMask</span><span class="op">(</span><span class="va">qaMask</span><span class="op">)</span><span class="op">$</span>
    <span class="fu">updateMask</span><span class="op">(</span><span class="va">saturationMask</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Map over the distinct years collection to build a list of annual image</span>
<span class="co"># composites.</span>
<span class="va">lsCompList</span> <span class="op">&lt;-</span> <span class="va">joinCol</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Get the list of images belonging to the given year.</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">fromImages</span><span class="op">(</span><span class="va">img</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"year_match"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co"># Apply cloud mask.</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="va">maskL457sr</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co"># Reduce image collection by median.</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">reduce</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">median</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co"># Set composite year as an image property.</span>
    <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">copyProperties</span><span class="op">(</span><span class="va">img</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Convert the image List to an ImageCollection.</span>
<span class="va">lsCompCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="va">lsCompList</span><span class="op">)</span></code></pre></div>
</div>
<div id="same-day-composite-by-join-and-reduce" class="section level5 unnumbered">
<h5>
<strong>Same-day composite by join and reduce</strong><a class="anchor" aria-label="anchor" href="#same-day-composite-by-join-and-reduce"><i class="fas fa-link"></i></a>
</h5>
<p>An additional case for compositing is to create spatially contiguous image mosaics. Suppose your region of interest spans two Landsat rows within the same path and your objective is to display an image mosaic of the two images for each Landsat 8 orbit in 2017 and 2018. Here, after filtering the collection by path and row, a join operation is used to mosaic Landsat images from the same obit, defined by acquisition date.</p>
<div class="sourceCode" id="cb355"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lsCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"LANDSAT/LC08/C02/T1_L2"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2017-01-01"</span>, <span class="st">"2019-01-01"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="st">"WRS_PATH == 38 &amp;&amp; (WRS_ROW == 28 || WRS_ROW == 29)"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">date</span> <span class="op">&lt;-</span> <span class="va">img</span><span class="op">$</span><span class="fu">date</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">format</span><span class="op">(</span><span class="st">"YYYY-MM-dd"</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">img</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"date"</span>, <span class="va">date</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

<span class="co"># Make a distinct date collection; one image representative per date.</span>
<span class="va">distinctDates</span> <span class="op">&lt;-</span> <span class="va">lsCol</span><span class="op">$</span><span class="fu">distinct</span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span><span class="op">$</span><span class="fu">sort</span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>

<span class="co"># Define a join filter; one-to-many join on ‘date’ property.</span>
<span class="va">filter</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">equals</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">leftField</span> <span class="op">&lt;-</span> <span class="st">"date"</span>, <span class="va">rightField</span> <span class="op">&lt;-</span> <span class="st">"date"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Define a join.</span>
<span class="va">join</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Join</span><span class="op">$</span><span class="fu">saveAll</span><span class="op">(</span><span class="st">"date_match"</span><span class="op">)</span>

<span class="co"># Apply the join; results in 'date_match' property being added to each distinct</span>
<span class="co"># date representative image. The list includes all images in the collection</span>
<span class="co"># belonging to the respective date.</span>
<span class="va">joinCol</span> <span class="op">&lt;-</span> <span class="va">join</span><span class="op">$</span><span class="fu">apply</span><span class="op">(</span><span class="va">distinctDates</span>, <span class="va">lsCol</span>, <span class="va">filter</span><span class="op">)</span>

<span class="va">lsColMos</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="va">joinCol</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">fromImages</span><span class="op">(</span><span class="va">col</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"date_match"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">mosaic</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="sorting" class="section level4 unnumbered">
<h4>Sorting<a class="anchor" aria-label="anchor" href="#sorting"><i class="fas fa-link"></i></a>
</h4>
<p>Sort a collection by time to ensure proper chronological sequence, or order by a property of your choice. By default, the visualization frame series is sorted in natural order of the collection. The arrangement of the series can be altered using the <code>sort</code> collection method, whereby an <code>Image</code> property is selected for sorting in either ascending or descending order. For example, to sort by time of observation, use the ubiquitous <code>system:time_start</code> property.</p>
<div class="sourceCode" id="cb356"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ee_geom</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="op">-</span><span class="fl">122.1</span>, <span class="fl">37.2</span><span class="op">)</span>
<span class="va">s2col</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"COPERNICUS/S2_SR"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">ee_geom</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">sort</span><span class="op">(</span><span class="st">"system:time_start"</span><span class="op">)</span></code></pre></div>
<p>Or perhaps the order should be defined by increasing cloudiness, as in this case of Sentinel-2 imagery.</p>
<div class="sourceCode" id="cb357"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ee_geom</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="op">-</span><span class="fl">122.1</span>, <span class="fl">37.2</span><span class="op">)</span>
<span class="va">s2col</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"COPERNICUS/S2_SR"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">ee_geom</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">sort</span><span class="op">(</span><span class="st">"CLOUDY_PIXEL_PERCENTAGE"</span><span class="op">)</span></code></pre></div>
<p>Order can also be defined by a derived property, such as mean regional NDVI. Here, regional NDVI is added as a property to each image in a mapped function, followed by a sort on the new property.</p>
<div class="sourceCode" id="cb358"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define an area of interest geometry.</span>
<span class="va">aoi</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="op">-</span><span class="fl">122.1</span>, <span class="fl">37.2</span><span class="op">)</span><span class="op">$</span><span class="fu">buffer</span><span class="op">(</span><span class="fl">1e4</span><span class="op">)</span>

<span class="co"># Filter MODIS NDVI image collection by a date range.</span>
<span class="va">ndviCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"MODIS/006/MOD13A1"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2018-01-01"</span>, <span class="st">"2019-01-01"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">aoi</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"NDVI"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Map over the image collection to calculate regional mean NDVI and add</span>
  <span class="co"># the result to each image as a property.</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">meanNdvi</span> <span class="op">&lt;-</span> <span class="va">img</span><span class="op">$</span><span class="fu">reduceRegion</span><span class="op">(</span>
      reducer <span class="op">=</span> <span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span>,
      geometry <span class="op">=</span> <span class="va">aoi</span>,
      scale <span class="op">=</span> <span class="fl">500</span>
    <span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">img</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"meanNdvi"</span>, <span class="va">meanNdvi</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"NDVI"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Sort the collection by descending regional mean NDVI.</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">sort</span><span class="op">(</span><span class="st">"meanNdvi"</span>, <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div id="image-visualization-1" class="section level4 unnumbered">
<h4>Image visualization<a class="anchor" aria-label="anchor" href="#image-visualization-1"><i class="fas fa-link"></i></a>
</h4>
<p>Image visualization transforms numbers into colors. There are three ways to control how image data are represented as color in collection visualization methods:</p>
<ol style="list-style-type: decimal">
<li><p>Provide visualization arguments directly to <code>getVideoThumbURL</code> and <code>getFilmstripThumbUR</code>.</p></li>
<li><p>Map the visualize image method over the image collection prior to application of <code>getVideoThumbURL</code> and <code>getFilmstripThumbUR</code>.</p></li>
<li><p>Map the sldStyle image method over the image collection prior to application of <code>getVideoThumbURL</code> and <code>getFilmstripThumbUR</code>. See <a href="">Styled Layer Descriptor</a> for more information.</p></li>
</ol>
<p>The examples in this guide use options 1 and 2, where visualization is achieved by mapping three image bands of a multi-band image to color channels red, green, and blue or grading values of a single band linearly along a color palette. Visualization parameters include:</p>
<div class="devsite-table-wrapper">
<div class="inline-table"><table style="width:100%" class="table table-sm"><tbody>
<tr>
<th>
Parameter
</th>
<th>
Description
</th>
<th>
Type
</th>
</tr>
<tr>
<td>
<i>bands</i>
</td>
<td>
Comma-delimited list of three band names to be mapped to RGB
</td>
<td>
list
</td>
</tr>
<tr>
<td>
<i>min</i>
</td>
<td>
Value(s) to map to 0
</td>
<td>
number or list of three numbers, one for each band
</td>
</tr>
<tr>
<td>
<i>max</i>
</td>
<td>
Value(s) to map to 255
</td>
<td>
number or list of three numbers, one for each band
</td>
</tr>
<tr>
<td>
<i>gain</i>
</td>
<td>
Value(s) by which to multiply each pixel value
</td>
<td>
number or list of three numbers, one for each band
</td>
</tr>
<tr>
<td>
<i>bias</i>
</td>
<td>
Value(s) to add to each DN
</td>
<td>
number or list of three numbers, one for each band
</td>
</tr>
<tr>
<td>
<i>gamma</i>
</td>
<td>
Gamma correction factor(s)
</td>
<td>
number or list of three numbers, one for each band
</td>
</tr>
<tr>
<td>
<i>palette</i>
</td>
<td>
List of CSS-style color strings (single-band images only)
</td>
<td>
comma-separated list of hex strings
</td>
</tr>
<tr>
<td>
<i>opacity</i>
</td>
<td>
The opacity of the layer (0.0 is fully transparent and 1.0 is fully opaque)
</td>
<td>
number
</td>
</tr>
</tbody></table></div>
</div>
<p>
</p>
<p>Use the bands argument to select the band(s) you wish to visualize. Provide a list of either one or three band names. With regard to multi-band images, the first three bands are selected by default. Band name order determines color assignment; the first, second, and third listed bands are mapped to red, green, and blue, respectively.</p>
<p>Data range scaling is an important consideration when visualizing images. By default, floating point data values between 0 and 1 (inclusive) are scaled between 0 and 255 (inclusive). Values outside this range are forced to 0 and 255 depending on whether they are less than 0 or greater than 1, respectively. With regard to integer data, the full capacity defined by its type is scaled between 0 and 255 (e.g., signed 16-bit data has a range from −32,768 to 32,767, which scales to [0, 255], by default). Accepting the defaults can often result in visualizations with little to no contrast between image features. Use <code>min</code> and <code>max</code> to improve contrast and emphasize a particular data range. A good rule of thumb is to set <code>min</code> and <code>max</code> to values that represent the 2nd and 98th percentile of the data within your area of interest. See the following example of calculating these values for a digital elevation model.</p>
<div class="sourceCode" id="cb359"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Import SRTM global elevation model.</span>
<span class="va">demImg</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="st">"USGS/SRTMGL1_003"</span><span class="op">)</span>

<span class="co"># Define a rectangular area of interest.</span>
<span class="va">aoi</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Polygon</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">103.84153083119054</span>, <span class="fl">49.083004219142886</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">103.84153083119054</span>, <span class="fl">25.06838270664608</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">85.64817145619054</span>, <span class="fl">25.06838270664608</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">85.64817145619054</span>, <span class="fl">49.083004219142886</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span>

<span class="co"># Calculate the 2nd and 98th percentile elevation values from rescaled (to</span>
<span class="co"># 500m) pixels intersecting the area of interest. A Dictionary is returned.</span>
<span class="va">percentClip</span> <span class="op">&lt;-</span> <span class="va">demImg</span><span class="op">$</span><span class="fu">reduceRegion</span><span class="op">(</span>
  reducer <span class="op">=</span> <span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">percentile</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">98</span><span class="op">)</span><span class="op">)</span>,
  geometry <span class="op">=</span> <span class="va">aoi</span>,
  scale <span class="op">=</span> <span class="fl">500</span>,
  maxPixels <span class="op">=</span> <span class="fl">3e7</span>
<span class="op">)</span>

<span class="co"># Print the regional 2nd and 98th percentile elevation values. Get the</span>
<span class="co"># dictionary keys and use them to get the values for each percentile summary.</span>
<span class="va">keys</span> <span class="op">&lt;-</span> <span class="va">percentClip</span><span class="op">$</span><span class="fu">keys</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="fu">Number</span><span class="op">(</span><span class="va">percentClip</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="va">keys</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">round</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="fu">Number</span><span class="op">(</span><span class="va">percentClip</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="va">keys</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">round</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The <code>palette</code> parameter defines the colors to represent the 8-bit visualization image. It applies only to single-band representations; specifying it with a multi-band image results in an error. If the data are single-band or you would like to visualize a single band from a multi-band image, set the <code>forceRgbOutput</code> parameter to <code>true</code> (unnecessary if the <code>palette</code> argument is provided). Use the <code>min</code> and <code>max</code> parameters to define the range of values to linearly scale between 0 and 255.</p>
<p><strong>Note:</strong>
- You cannot provide both <code>gain/bias</code> and <code>min/max</code> arguments.
- The <code>opacity</code> visualization parameter has no effect on animations, but is respected for filmstrip visualization.
- Visualizations resulting from <code>getVideoThumbURL</code> and <code>getFilmstripThumbURL</code> will appear black where collection images are masked out.</p>
<p>An example of mapping a visualization function over a single-band image collection follows. A MODIS NDVI collection is imported, visualization arguments for the <code>visualization</code> method are set, and a function that transforms values into RGB image representations is mapped over the NDVI collection.</p>
<div class="sourceCode" id="cb360"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Filter MODIS NDVI image collection by a date range.</span>
<span class="va">ndviCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"MODIS/006/MOD13A1"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2018-01-01"</span>, <span class="st">"2019-01-01"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"NDVI"</span><span class="op">)</span>

<span class="co"># Define visualization arguments.</span>
<span class="va">visArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  min <span class="op">=</span> <span class="fl">0</span>,
  max <span class="op">=</span> <span class="fl">9000</span>,
  palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"FFFFFF"</span>, <span class="st">"CE7E45"</span>, <span class="st">"DF923D"</span>, <span class="st">"F1B555"</span>, <span class="st">"FCD163"</span>, <span class="st">"99B718"</span>, <span class="st">"74A901"</span>,
    <span class="st">"66A000"</span>, <span class="st">"529400"</span>, <span class="st">"3E8601"</span>, <span class="st">"207401"</span>, <span class="st">"056201"</span>, <span class="st">"004C00"</span>, <span class="st">"023B01"</span>,
    <span class="st">"012E01"</span>, <span class="st">"011D01"</span>, <span class="st">"011301"</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="co"># Define a function to convert an image to an RGB visualization image and copy</span>
<span class="co"># properties from the original image to the RGB image.</span>
<span class="va">visFun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">img</span><span class="op">$</span><span class="fu">visualize</span><span class="op">(</span><span class="va">visArgs</span><span class="op">)</span><span class="op">$</span><span class="fu">copyProperties</span><span class="op">(</span><span class="va">img</span>, <span class="va">img</span><span class="op">$</span><span class="fu">propertyNames</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Map over the image collection to convert each image to an RGB visualization</span>
<span class="co"># using the previously defined visualization function.</span>
<span class="va">ndviColVis</span> <span class="op">&lt;-</span> <span class="va">ndviCol</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="va">visFun</span><span class="op">)</span></code></pre></div>
<p>Here is an example of mapping a visualization function over a multi-band image collection:</p>
<div class="sourceCode" id="cb361"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Assemble a collection of Sentinel-2 surface reflectance images for a given</span>
<span class="co"># region and date range.</span>
<span class="va">s2col</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"COPERNICUS/S2_SR"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="op">-</span><span class="fl">96.9037</span>, <span class="fl">48.0395</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2019-06-01"</span>, <span class="st">"2019-10-01"</span><span class="op">)</span>

<span class="co"># Define visualization arguments.</span>
<span class="va">visArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B11"</span>, <span class="st">"B8"</span>, <span class="st">"B3"</span><span class="op">)</span>,
  min <span class="op">=</span> <span class="fl">300</span>,
  max <span class="op">=</span> <span class="fl">3500</span>
<span class="op">)</span>

<span class="co"># Define a function to convert an image to an RGB visualization image and copy</span>
<span class="co"># properties from the original image to the RGB image.</span>
<span class="va">visFun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">img</span><span class="op">$</span><span class="fu">visualize</span><span class="op">(</span><span class="va">visArgs</span><span class="op">)</span><span class="op">$</span><span class="fu">copyProperties</span><span class="op">(</span><span class="va">img</span>, <span class="va">img</span><span class="op">$</span><span class="fu">propertyNames</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Map over the image collection to convert each image to an RGB visualization</span>
<span class="co"># using the previously defined visualization function.</span>
<span class="va">s2colVis</span> <span class="op">&lt;-</span> <span class="va">s2col</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="va">visFun</span><span class="op">)</span></code></pre></div>
<p>In this case, no palette argument is provided because three bands are given, which define intensity for each RGB layer. Note that both examples use the <code>min</code> and <code>max</code> parameters to control what values are stretched to the limits of the 8-bit RGB data.</p>
</div>
</div>
<div id="video-thumb" class="section level3 unnumbered">
<h3>Video thumb<a class="anchor" aria-label="anchor" href="#video-thumb"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>getVideoThumbURL()</code> function generates an animation from all images in an <code>ImageCollection</code> where each image represents a frame. The general workflow for producing an animation is as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Define a <code>Geometry</code> whose bounds determine the regional extent of the animation.</p></li>
<li><p>Define an <code>ImageCollection</code>.</p></li>
<li><p>Consider image visualization: either map an image visualization function over the collection or add image visualization arguments to the set of animation arguments.</p></li>
<li><p>Define animation arguments and call the <code>getVideoThumbURL</code> method.</p></li>
</ol>
<p>The result of <code>getVideoThumbURL</code> is a URL. Print the URL to the console and click it to start Earth Engine servers generating the animation on-the-fly in a new browser tab. Alternatively, view the animation in the Rstudio console by calling the <code>ui$Thumbnail</code> function on the collection and its corresponding animation arguments. Upon rendering, the animation is available for downloading by right clicking on it and selecting appropriate options from its context menu.</p>
<p>The following example illustrates generating an animation depicting global temperatures over the course of 24 hours. Note that this example includes visualization arguments along with animation arguments, as opposed to first mapping a visualization function over the <code>ImageCollection</code>. Upon running this script, an animation similar to Figure 4 should appear in the Rstudio console.</p>
<div class="sourceCode" id="cb362"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define an area of interest geometry with a global non-polar extent.</span>
<span class="va">aoi</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Polygon</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">179.0</span>, <span class="fl">78.0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">179.0</span>, <span class="op">-</span><span class="fl">58.0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">179.0</span>, <span class="op">-</span><span class="fl">58.0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">179.0</span>, <span class="fl">78.0</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Import hourly predicted temperature image collection for northern winter</span>
<span class="co"># solstice. Note that predictions extend for 384 hours; limit the collection</span>
<span class="co"># to the first 24 hours.</span>
<span class="va">tempCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"NOAA/GFS0P25"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2018-12-22"</span>, <span class="st">"2018-12-23"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">limit</span><span class="op">(</span><span class="fl">24</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"temperature_2m_above_ground"</span><span class="op">)</span>

<span class="co"># Define arguments for animation function parameters.</span>
<span class="va">videoArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  dimensions <span class="op">=</span> <span class="fl">768</span>,
  region <span class="op">=</span> <span class="va">aoi</span>,
  framesPerSecond <span class="op">=</span> <span class="fl">7</span>,
  crs <span class="op">=</span> <span class="st">"EPSG:3857"</span>,
  min <span class="op">=</span> <span class="op">-</span><span class="fl">40.0</span>,
  max <span class="op">=</span> <span class="fl">35.0</span>,
  palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"purple"</span>, <span class="st">"cyan"</span>, <span class="st">"green"</span>, <span class="st">"yellow"</span>, <span class="st">"red"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Print the animation to the console as a ui.Thumbnail using the above defined</span>
<span class="co"># arguments. Note that ui.Thumbnail produces an animation when the first input</span>
<span class="co"># is an ee.ImageCollection instead of an ee$Image.</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ui</span><span class="op">$</span><span class="fu">Thumbnail</span><span class="op">(</span><span class="va">tempCol</span>, <span class="va">videoArgs</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Alternatively, print a URL that will produce the animation when accessed.</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tempCol</span><span class="op">$</span><span class="fu">getVideoThumbURL</span><span class="op">(</span><span class="va">videoArgs</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/gif/chapter_05/gif_03.gif" width="670" alt=""><p class="caption">Figure 4. Hourly surface temperature for the northern winter solstice represented as an animated GIF image.</p>
</div>
<p><strong>Note:</strong>
- The maximum number of pixels allowed in an animation is 6,553,600 (e.g., 256 x 256 x 100).
- The authorization token to process the thumbnail lasts 2 hours. Until it expires, anyone with the authorization token can generate the image.</p>
</div>
<div id="filmstrip" class="section level3 unnumbered">
<h3>Filmstrip<a class="anchor" aria-label="anchor" href="#filmstrip"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>getFilmstripThumbUrl</code> function generates a single static image representing the concatenation of all images in an <code>ImageCollection</code> into a north-south series. The sequence of filmstrip frames follow the natural order of the collection.</p>
<p>The result of <code>getFilmstripThumbUrl</code> is a URL. Print the URL to the console and click it to start Earth Engine servers generating the image on-the-fly in a new browser tab. Upon rendering, the image is available for downloading by right clicking on it and selecting appropriate options from its context menu.</p>
<p>The following code snippet uses the same collection as the video thumb example above. Upon running this script, a filmstrip similar to Figure 5 should appear in the Rstudio console.</p>
<div class="sourceCode" id="cb363"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define an area of interest geometry with a global non-polar extent.</span>
<span class="va">aoi</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Polygon</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">179.0</span>, <span class="fl">78.0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">179.0</span>, <span class="op">-</span><span class="fl">58.0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">179.0</span>, <span class="op">-</span><span class="fl">58.0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">179.0</span>, <span class="fl">78.0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="cn">NULL</span>, <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="co"># Import hourly predicted temperature image collection for northern winter</span>
<span class="co"># solstice. Note that predictions extend for 384 hours; limit the collection</span>
<span class="co"># to the first 24 hours.</span>
<span class="va">tempCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"NOAA/GFS0P25"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2018-12-22"</span>, <span class="st">"2018-12-23"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">limit</span><span class="op">(</span><span class="fl">24</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"temperature_2m_above_ground"</span><span class="op">)</span>

<span class="co"># Define arguments for the getFilmstripThumbURL function parameters.</span>
<span class="va">filmArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  dimensions <span class="op">=</span> <span class="fl">128</span>,
  region <span class="op">=</span> <span class="va">aoi</span>,
  crs <span class="op">=</span> <span class="st">"EPSG:3857"</span>,
  min <span class="op">=</span> <span class="op">-</span><span class="fl">40.0</span>,
  max <span class="op">=</span> <span class="fl">35.0</span>,
  palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"purple"</span>, <span class="st">"cyan"</span>, <span class="st">"green"</span>, <span class="st">"yellow"</span>, <span class="st">"red"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Print a URL that will produce the filmstrip when accessed.</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tempCol</span><span class="op">$</span><span class="fu">getFilmstripThumbURL</span><span class="op">(</span><span class="va">filmArgs</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/chapter_05/figure_04.png" width="670" alt=""><p class="caption">Figure 5. Hourly surface temperature for the northern winter solstice represented as a filmstrip PNG image. Note that the filmstrip has been divided into four sections for display; the result of getFilmstripThumbURL is a single series of collection images joined north-south.</p>
</div>
</div>
<div id="advanced-techniques" class="section level3 unnumbered">
<h3>Advanced techniques<a class="anchor" aria-label="anchor" href="#advanced-techniques"><i class="fas fa-link"></i></a>
</h3>
<p>The following sections describe how to use clipping, opacity, and layer compositing to enhance visualizations by adding polygon borders, emphasizing regions of interest, and comparing images within a collection.</p>
<p>Note that all of the following examples in this section use the same base <code>ImageCollection</code> defined here:</p>
<div class="sourceCode" id="cb364"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Import hourly predicted temperature image collection for northern winter</span>
<span class="co"># solstice. Note that predictions extend for 384 hours; limit the collection</span>
<span class="co"># to the first 24 hours.</span>
<span class="va">tempCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"NOAA/GFS0P25"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2018-12-22"</span>, <span class="st">"2018-12-23"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">limit</span><span class="op">(</span><span class="fl">24</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"temperature_2m_above_ground"</span><span class="op">)</span>

<span class="co"># Define visualization arguments to control the stretch and color gradient</span>
<span class="co"># of the data.</span>
<span class="va">videoArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  min <span class="op">=</span> <span class="op">-</span><span class="fl">40.0</span>,
  max <span class="op">=</span> <span class="fl">35.0</span>,
  palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"purple"</span>, <span class="st">"cyan"</span>, <span class="st">"green"</span>, <span class="st">"yellow"</span>, <span class="st">"red"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Convert each image to an RGB visualization image by mapping the visualize</span>
<span class="co"># function over the image collection using the arguments defined previously.</span>
<span class="va">tempColVis</span> <span class="op">&lt;-</span> <span class="va">tempCol</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">img</span><span class="op">$</span><span class="fu">visualize</span><span class="op">(</span><span class="va">visArgs</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Import country features and filter to South American countries.</span>
<span class="va">southAmCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">FeatureCollection</span><span class="op">(</span><span class="st">"USDOS/LSIB_SIMPLE/2017"</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">filterMetadata</span><span class="op">(</span><span class="st">"wld_rgn"</span>, <span class="st">"equals"</span>, <span class="st">"South America"</span><span class="op">)</span>

<span class="co"># Define animation region (South America with buffer).</span>
<span class="va">southAmAoi</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Rectangle</span><span class="op">(</span>
  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">103.6</span>, <span class="op">-</span><span class="fl">58.8</span>, <span class="op">-</span><span class="fl">18.4</span>, <span class="fl">17.4</span><span class="op">)</span>,
  geodesic <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<div id="overlays" class="section level4 unnumbered">
<h4>Overlays<a class="anchor" aria-label="anchor" href="#overlays"><i class="fas fa-link"></i></a>
</h4>
<p>Multiple images can be overlaid using the <code>blend</code> <code>Image</code> method where overlapping pixels from two images are blended based on their masks (opacity).</p>
<div id="vector-overlay" class="section level5 unnumbered">
<h5>Vector overlay<a class="anchor" aria-label="anchor" href="#vector-overlay"><i class="fas fa-link"></i></a>
</h5>
<p>Adding administrative boundary polygons and other geometries to an image can provide valuable spatial context. Consider the global daily surface temperature animation above (Figure 3). The boundaries between land and ocean are somewhat discernible, but they can be made explicit by adding a polygon overlay of countries.</p>
<p>Vector data ( <code>Features</code> ) are drawn to images by applying the <code>paint</code> method. Features can be painted to an existing image, but the better practice is to paint them to a blank image, style it, and then blend the result with other styled image layers. Treating each layer of a visualization stack independently affords more control over styling.</p>
<p>The following example demonstrates painting South American country borders to a blank <code>Image</code> and blending the result with each <code>Image</code> of the global daily temperature collection (Figure 6). The overlaid country boundaries distinguish land from water and provide context to patterns of temperature.</p>
<div class="sourceCode" id="cb365"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define an empty image to paint features to.</span>
<span class="va">empty</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">byte</span><span class="op">(</span><span class="op">)</span>

<span class="co"># Paint country feature edges to the empty image.</span>
<span class="va">southAmOutline</span> <span class="op">&lt;-</span> <span class="va">empty</span><span class="op">$</span>
  <span class="fu">paint</span><span class="op">(</span>
  featureCollection <span class="op">=</span> <span class="va">southAmCol</span>,
  color <span class="op">=</span> <span class="fl">1</span>,
  width <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span><span class="op">$</span>

  <span class="co"># Convert to an RGB visualization image; set line color to black.</span>
  <span class="fu">visualize</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"000000"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Map a blend operation over the temperature collection to overlay the country</span>
<span class="co"># border outline image on all collection images.</span>
<span class="va">tempColOutline</span> <span class="op">&lt;-</span> <span class="va">tempColVis</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">img</span><span class="op">$</span><span class="fu">blend</span><span class="op">(</span><span class="va">southAmOutline</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Define animation region (South America with buffer).</span>
<span class="va">southAmAoi</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Rectangle</span><span class="op">(</span>
  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">103.6</span>, <span class="op">-</span><span class="fl">58.8</span>, <span class="op">-</span><span class="fl">18.4</span>, <span class="fl">17.4</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Define animation arguments.</span>
<span class="va">videoArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  dimensions <span class="op">=</span> <span class="fl">768</span>,
  region <span class="op">=</span> <span class="va">southAmAoi</span>,
  framesPerSecond <span class="op">=</span> <span class="fl">7</span>,
  crs <span class="op">=</span> <span class="st">"EPSG:3857"</span>
<span class="op">)</span>

<span class="co"># Display the animation.</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ui</span><span class="op">$</span><span class="fu">Thumbnail</span><span class="op">(</span><span class="va">tempColOutline</span>, <span class="va">videoArgs</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/gif/chapter_05/gif_05.gif" width="670" alt=""><p class="caption">Figure 6. Add vector overlays to images in a collection to provide spatial context.</p>
</div>
</div>
<div id="image-overlay" class="section level5 unnumbered">
<h5>Image overlay<a class="anchor" aria-label="anchor" href="#image-overlay"><i class="fas fa-link"></i></a>
</h5>
<p>Several images can be overlaid to achieve a desired style. Suppose you want to emphasize a region of interest. You can create a muted copy of an image visualization as a base layer and then overlay a clipped version of the original visualization. Building on the previous example, the following script produces Figure 7.</p>
<div class="sourceCode" id="cb366"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define an empty image to paint features to.</span>
<span class="va">empty</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">byte</span><span class="op">(</span><span class="op">)</span>

<span class="co"># Paint country feature edges to the empty image.</span>
<span class="va">southAmOutline</span> <span class="op">&lt;-</span> <span class="va">empty</span><span class="op">$</span><span class="fu">paint</span><span class="op">(</span><span class="va">featureCollection</span> <span class="op">&lt;-</span> <span class="va">southAmCol</span>, <span class="va">color</span> <span class="op">&lt;-</span> <span class="fl">1</span>, <span class="va">width</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span>
  <span class="co"># Convert to an RGB visualization image; set line color to black.</span>
  <span class="fu">visualize</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"000000"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Map a blend operation over the temperature collection to overlay the country</span>
<span class="co"># border outline image on all collection images.</span>
<span class="va">tempColOutline</span> <span class="op">&lt;-</span> <span class="va">tempColVis</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">img</span><span class="op">$</span><span class="fu">blend</span><span class="op">(</span><span class="va">southAmOutline</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Define a partially opaque grey RGB image to dull the underlying image when</span>
<span class="co"># blended as an overlay.</span>
<span class="va">dullLayer</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Image</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="fl">175</span><span class="op">)</span><span class="op">$</span><span class="fu">visualize</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  opacity <span class="op">=</span> <span class="fl">0.6</span>,
  min <span class="op">=</span> <span class="fl">0</span>,
  max <span class="op">=</span> <span class="fl">255</span>,
  forceRgbOutput <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span><span class="op">)</span>

<span class="co"># Map a two-part blending operation over the country outline temperature</span>
<span class="co"># collection for final styling.</span>
<span class="va">finalVisCol</span> <span class="op">&lt;-</span> <span class="va">tempColOutline</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span><span class="op">$</span>
    <span class="co"># Blend the dulling layer with the given country outline temperature image.</span>
    <span class="fu">blend</span><span class="op">(</span><span class="va">dullLayer</span><span class="op">)</span><span class="op">$</span>
    <span class="co"># Blend a clipped copy of the country outline temperature image with the</span>
    <span class="co"># dulled background image.</span>
    <span class="fu">blend</span><span class="op">(</span><span class="va">img</span><span class="op">$</span><span class="fu">clipToCollection</span><span class="op">(</span><span class="va">southAmCol</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Define animation region (South America with buffer).</span>
<span class="va">southAmAoi</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Rectangle</span><span class="op">(</span>
  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">103.6</span>, <span class="op">-</span><span class="fl">58.8</span>, <span class="op">-</span><span class="fl">18.4</span>, <span class="fl">17.4</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Define animation arguments.</span>
<span class="va">videoArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  dimensions <span class="op">=</span> <span class="fl">768</span>,
  region <span class="op">=</span> <span class="va">southAmAoi</span>,
  framesPerSecond <span class="op">=</span> <span class="fl">7</span>,
  crs <span class="op">=</span> <span class="st">"EPSG:3857"</span>
<span class="op">)</span>

<span class="co"># Display the animation.</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ui</span><span class="op">$</span><span class="fu">Thumbnail</span><span class="op">(</span><span class="va">finalVisCol</span>, <span class="va">videoArgs</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/gif/chapter_05/gif_06.gif" width="760" alt=""><p class="caption">Figure 7. Emphasize an area of interest by clipping the image and overlaying it on a muted copy.</p>
</div>
<p>You can also blend image data with a hillshade base layer to indicate terrain and give the visualization some depth (Figure 8).</p>
<div class="sourceCode" id="cb367"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define a hillshade layer from SRTM digital elevation model.</span>
<span class="va">hillshade</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Terrain</span><span class="op">$</span><span class="fu">hillshade</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="st">"USGS/SRTMGL1_003"</span><span class="op">)</span><span class="op">$</span>
  <span class="co"># Exaggerate the elevation to increase contrast in hillshade</span>
  <span class="fu">multiply</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">$</span>
  <span class="co"># Clip the DEM by South American boundary to clean boundary between</span>
  <span class="co"># land and ocean.</span>
  <span class="fu">clipToCollection</span><span class="op">(</span><span class="va">southAmCol</span><span class="op">)</span>

<span class="co"># Map a blend operation over the temperature collection to overlay a partially</span>
<span class="co"># opaque temperature layer on the hillshade layer.</span>
<span class="va">finalVisCol</span> <span class="op">&lt;-</span> <span class="va">tempColVis</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">hillshade</span><span class="op">$</span>
    <span class="fu">blend</span><span class="op">(</span><span class="va">img</span><span class="op">$</span><span class="fu">clipToCollection</span><span class="op">(</span><span class="va">southAmCol</span><span class="op">)</span><span class="op">$</span><span class="fu">visualize</span><span class="op">(</span><span class="op">{</span>
    <span class="va">opacity</span> <span class="op">&lt;-</span> <span class="fl">0.6</span>
  <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Define animation region (South America with buffer).</span>
<span class="va">southAmAoi</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Rectangle</span><span class="op">(</span>
  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">103.6</span>, <span class="op">-</span><span class="fl">58.8</span>, <span class="op">-</span><span class="fl">18.4</span>, <span class="fl">17.4</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Define animation arguments.</span>
<span class="va">videoArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  dimensions <span class="op">=</span> <span class="fl">768</span>,
  region <span class="op">=</span> <span class="va">southAmAoi</span>,
  framesPerSecond <span class="op">=</span> <span class="fl">7</span>,
  crs <span class="op">=</span> <span class="st">"EPSG:3857"</span>
<span class="op">)</span>

<span class="co"># Display the animation.</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ui</span><span class="op">$</span><span class="fu">Thumbnail</span><span class="op">(</span><span class="va">finalVisCol</span>, <span class="va">videoArgs</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/gif/chapter_05/gif_07.gif" width="670" alt=""><p class="caption">Figure 8. Show terrain by overlaying partially transparent image data on a hillshade layer.</p>
</div>
</div>
</div>
<div id="transitions" class="section level4 unnumbered">
<h4>Transitions<a class="anchor" aria-label="anchor" href="#transitions"><i class="fas fa-link"></i></a>
</h4>
<p>Customize an image collection to produce animations that reveal differences between two images within a collection using fade, flicker, and slide transitions. Each of the following examples use the same base visualization generated by the following script:</p>
<div class="sourceCode" id="cb368"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define an area of interest geometry with a global non-polar extent.</span>
<span class="va">aoi</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Polygon</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">179.0</span>, <span class="fl">78.0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">179.0</span>, <span class="op">-</span><span class="fl">58.0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">179.0</span>, <span class="op">-</span><span class="fl">58.0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">179.0</span>, <span class="fl">78.0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Import hourly predicted temperature image collection.</span>
<span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"NOAA/GFS0P25"</span><span class="op">)</span>

<span class="co"># Define a northern summer solstice temperature image.</span>
<span class="va">summerSolTemp</span> <span class="op">&lt;-</span> <span class="va">temp</span><span class="op">$</span>
  <span class="fu">filterDate</span><span class="op">(</span><span class="st">"2018-06-21"</span>, <span class="st">"2018-06-22"</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">filterMetadata</span><span class="op">(</span><span class="st">"forecast_hours"</span>, <span class="st">"equals"</span>, <span class="fl">12</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">first</span><span class="op">(</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">select</span><span class="op">(</span><span class="st">"temperature_2m_above_ground"</span><span class="op">)</span>

<span class="co"># Define a northern winter solstice temperature image.</span>
<span class="va">winterSolTemp</span> <span class="op">&lt;-</span> <span class="va">temp</span><span class="op">$</span>
  <span class="fu">filterDate</span><span class="op">(</span><span class="st">"2018-12-22"</span>, <span class="st">"2018-12-23"</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">filterMetadata</span><span class="op">(</span><span class="st">"forecast_hours"</span>, <span class="st">"equals"</span>, <span class="fl">12</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">first</span><span class="op">(</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">select</span><span class="op">(</span><span class="st">"temperature_2m_above_ground"</span><span class="op">)</span>

<span class="co"># Combine the solstice images into a collection.</span>
<span class="va">tempCol</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="va">summerSolTemp</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"season"</span>, <span class="st">"summer"</span><span class="op">)</span>,
  <span class="va">winterSolTemp</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"season"</span>, <span class="st">"winter"</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span>

<span class="co"># Import international boundaries feature collection.</span>
<span class="va">countries</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">FeatureCollection</span><span class="op">(</span><span class="st">"USDOS/LSIB_SIMPLE/2017"</span><span class="op">)</span>

<span class="co">## Define visualization arguments.</span>
<span class="va">visArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  min <span class="op">=</span> <span class="op">-</span><span class="fl">40.0</span>,
  max <span class="op">=</span> <span class="fl">35.0</span>,
  palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"purple"</span>, <span class="st">"cyan"</span>, <span class="st">"green"</span>, <span class="st">"yellow"</span>, <span class="st">"red"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Convert the image data to RGB visualization images.</span>
<span class="co"># The clip and unmask combination sets ocean pixels to black.</span>
<span class="va">tempColVis</span> <span class="op">&lt;-</span> <span class="va">tempCol</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">img</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">img</span><span class="op">$</span>
    <span class="fu">visualize</span><span class="op">(</span><span class="va">visArgs</span><span class="op">)</span><span class="op">$</span>
    <span class="fu">visualize</span><span class="op">(</span><span class="va">visArgs</span><span class="op">)</span><span class="op">$</span>
    <span class="fu">unmask</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">$</span>
    <span class="fu">copyProperties</span><span class="op">(</span><span class="va">img</span>, <span class="va">img</span><span class="op">$</span><span class="fu">propertyNames</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<div id="flicker" class="section level5 unnumbered">
<h5>Flicker<a class="anchor" aria-label="anchor" href="#flicker"><i class="fas fa-link"></i></a>
</h5>
<p>With only two images in a collection, as is the case here, flicker is the default representation upon collection animation. Adjust the <code>framesPerSecond</code> animation argument to speed up or slow down the flicker rate. The following visualization arguments applied to the collection above produces Figure 9.</p>
<div class="sourceCode" id="cb369"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define arguments for animation function parameters.</span>
<span class="va">videoArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  dimensions <span class="op">=</span> <span class="fl">768</span>,
  region <span class="op">=</span> <span class="va">aoi</span>,
  framesPerSecond <span class="op">=</span> <span class="fl">2</span>,
  crs <span class="op">=</span> <span class="st">"EPSG:3857"</span>
<span class="op">)</span>

<span class="co"># Display animation to the Rstudio console.</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ui</span><span class="op">$</span><span class="fu">Thumbnail</span><span class="op">(</span><span class="va">tempColVis</span>, <span class="va">videoArgs</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/gif/chapter_05/gif_08.gif" width="670" alt=""><p class="caption">Figure 9. Example of flickering between 12pm GMT surface temperature for northern and winter solstice.</p>
</div>
</div>
<div id="fade" class="section level5 unnumbered">
<h5>Fade<a class="anchor" aria-label="anchor" href="#fade"><i class="fas fa-link"></i></a>
</h5>
<p>A fade transition between two layers is achieved by simultaneously decreasing the opacity of one layer while increasing the opacity of the other over a sequence of opacity increments from near 0 to 1 (Figure 10).</p>
<div class="sourceCode" id="cb370"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define a sequence of decreasing opacity increments. Note that opacity cannot</span>
<span class="co"># be 0, so near 1 and 0 are used. Near 1 is needed because a compliment is</span>
<span class="co"># calculated in a following step that can result in 0 if 1 is an element of the</span>
<span class="co"># list.</span>
<span class="va">opacityList</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">List</span><span class="op">$</span><span class="fu">sequence</span><span class="op">(</span>
  start <span class="op">=</span> <span class="fl">0.99999</span>,
  end <span class="op">=</span> <span class="fl">0.00001</span>,
  count <span class="op">=</span> <span class="fl">20</span>
<span class="op">)</span>

<span class="co"># Filter the summer and winter solstice images from the collection and set as</span>
<span class="co"># image objects.</span>
<span class="va">summerImg</span> <span class="op">&lt;-</span> <span class="va">tempColVis</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"season"</span>, <span class="st">"summer"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">first</span><span class="op">(</span><span class="op">)</span>
<span class="va">winterImg</span> <span class="op">&lt;-</span> <span class="va">tempColVis</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"season"</span>, <span class="st">"winter"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">first</span><span class="op">(</span><span class="op">)</span>

<span class="co"># Map over the list of opacity increments to iteratively adjust the opacity of</span>
<span class="co"># the two solstice images. Returns a list of images.</span>
<span class="va">imgList</span> <span class="op">&lt;-</span> <span class="va">opacityList</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">opacity</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">opacityCompliment</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Number</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">subtract</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="fu">Number</span><span class="op">(</span><span class="va">opacity</span><span class="op">)</span><span class="op">)</span>
  <span class="va">winterImgFade</span> <span class="op">&lt;-</span> <span class="va">winterImg</span><span class="op">$</span><span class="fu">visualize</span><span class="op">(</span><span class="op">{</span>
    <span class="va">opacity</span> <span class="op">&lt;-</span> <span class="va">opacity</span>
  <span class="op">}</span><span class="op">)</span>
  <span class="va">summerImgFade</span> <span class="op">&lt;-</span> <span class="va">summerImg</span><span class="op">$</span><span class="fu">visualize</span><span class="op">(</span><span class="op">{</span>
    <span class="va">opacity</span> <span class="op">&lt;-</span> <span class="va">opacityCompliment</span>
  <span class="op">}</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">summerImgFade</span><span class="op">$</span><span class="fu">blend</span><span class="op">(</span><span class="va">winterImgFade</span><span class="op">)</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"opacity"</span>, <span class="va">opacity</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Convert the image list to an image collection; the forward phase.</span>
<span class="va">fadeForward</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">fromImages</span><span class="op">(</span><span class="va">imgList</span><span class="op">)</span>

<span class="co"># Make a copy of the collection that is sorted by ascending opacity to</span>
<span class="co"># represent the reverse phase.</span>
<span class="va">fadeBackward</span> <span class="op">&lt;-</span> <span class="va">fadeForward</span><span class="op">$</span><span class="fu">sort</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">property</span> <span class="op">&lt;-</span> <span class="st">"opacity"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Merge the forward and reverse phase frame collections.</span>
<span class="va">fadeCol</span> <span class="op">&lt;-</span> <span class="va">fadeForward</span><span class="op">$</span><span class="fu">merge</span><span class="op">(</span><span class="va">fadeBackward</span><span class="op">)</span>

<span class="co"># Define animation arguments.</span>
<span class="va">videoArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  dimensions <span class="op">=</span> <span class="fl">768</span>,
  region <span class="op">=</span> <span class="va">aoi</span>,
  framesPerSecond <span class="op">=</span> <span class="fl">2</span>,
  crs <span class="op">=</span> <span class="st">"EPSG:3857"</span>
<span class="op">)</span>

<span class="co"># Display the animation.</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ui</span><span class="op">$</span><span class="fu">Thumbnail</span><span class="op">(</span><span class="va">fadeCol</span>, <span class="va">videoArgs</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/gif/chapter_05/gif_09.gif" width="670" alt=""><p class="caption">Figure 10. Example of fading between 12pm GMT surface temperature for summer and winter solstice.</p>
</div>
</div>
<div id="slider" class="section level5 unnumbered">
<h5>Slider<a class="anchor" aria-label="anchor" href="#slider"><i class="fas fa-link"></i></a>
</h5>
<p>A slider transition progressively shows and hides the underlying image layer. It is achieved by iteratively adjusting the opacity of the overlying image across a range of longitudes (Figure 11).</p>
<div class="sourceCode" id="cb371"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define a sequence of longitude increments. Start and end are defined by the</span>
<span class="co"># min and max longitude of the feature to be provided to the region parameter</span>
<span class="co"># of the animation arguments dictionary.</span>
<span class="va">lonSeq</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">List</span><span class="op">$</span><span class="fu">sequence</span><span class="op">(</span>
  start <span class="op">=</span> <span class="op">-</span><span class="fl">179</span>,
  end <span class="op">=</span> <span class="fl">179</span>,
  count <span class="op">=</span> <span class="fl">20</span>
<span class="op">)</span>

<span class="co"># Define a longitude image.</span>
<span class="va">longitude</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Image</span><span class="op">$</span><span class="fu">pixelLonLat</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"longitude"</span><span class="op">)</span>

<span class="co"># Filter the summer and winter solstice images from the collection and set as</span>
<span class="co"># image objects.</span>
<span class="va">summerImg</span> <span class="op">&lt;-</span> <span class="va">tempColVis</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"season"</span>, <span class="st">"summer"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">first</span><span class="op">(</span><span class="op">)</span>
<span class="va">winterImg</span> <span class="op">&lt;-</span> <span class="va">tempColVis</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"season"</span>, <span class="st">"winter"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">first</span><span class="op">(</span><span class="op">)</span>

<span class="co"># Map over the list of longitude increments to iteratively adjust the mask</span>
<span class="co"># (opacity) of the overlying image layer. Returns a list of images.</span>
<span class="va">imgList</span> <span class="op">&lt;-</span> <span class="va">lonSeq</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">lon</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">lon</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Number</span><span class="op">(</span><span class="va">lon</span><span class="op">)</span>
  <span class="va">mask</span> <span class="op">&lt;-</span> <span class="va">longitude</span><span class="op">$</span><span class="fu">gt</span><span class="op">(</span><span class="va">lon</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">summerImg</span><span class="op">$</span><span class="fu">blend</span><span class="op">(</span><span class="va">winterImg</span><span class="op">$</span><span class="fu">updateMask</span><span class="op">(</span><span class="va">mask</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"lon"</span>, <span class="va">lon</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Convert the image list to an image collection; concealing phase.</span>
<span class="va">sliderColForward</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">fromImages</span><span class="op">(</span><span class="va">imgList</span><span class="op">)</span>

<span class="co"># Make a copy of the collection that is sorted by descending longitude to</span>
<span class="co"># represent the revealing phase.</span>
<span class="va">sliderColbackward</span> <span class="op">&lt;-</span> <span class="va">sliderColForward</span><span class="op">$</span>
  <span class="fu">sort</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  property <span class="op">=</span> <span class="st">"lon"</span>,
  ascending <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span><span class="op">)</span>


<span class="co"># Merge the forward and backward phase frame collections.</span>
<span class="va">sliderCol</span> <span class="op">&lt;-</span> <span class="va">sliderColForward</span><span class="op">$</span><span class="fu">merge</span><span class="op">(</span><span class="va">sliderColbackward</span><span class="op">)</span>

<span class="co"># Define animation arguments.</span>
<span class="va">videoArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  dimensions <span class="op">=</span> <span class="fl">768</span>,
  region <span class="op">=</span> <span class="va">aoi</span>,
  framesPerSecond <span class="op">=</span> <span class="fl">25</span>,
  crs <span class="op">=</span> <span class="st">"EPSG:3857"</span>
<span class="op">)</span>

<span class="co"># Display the animation.</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ui</span><span class="op">$</span><span class="fu">Thumbnail</span><span class="op">(</span><span class="va">sliderCol</span>, <span class="va">videoArgs</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/gif/chapter_05/gif_10.gif" width="670" alt=""><p class="caption">Figure 11. Example of a sliding transition between 12pm GMT surface temperature for summer and winter solstice.</p>
</div>
</div>
</div>
</div>
</div>
<div id="imagecollection-information-and-metadata" class="section level2 unnumbered">
<h2>ImageCollection Information and Metadata<a class="anchor" aria-label="anchor" href="#imagecollection-information-and-metadata"><i class="fas fa-link"></i></a>
</h2>
<p>As with Images, there are a variety of ways to get information about an <code>ImageCollection</code>. The collection can be printed directly to the console, but the console printout is limited to 5000 elements. Collections larger than 5000 images will need to be filtered before printing. Printing a large collection will be correspondingly slower. The following example shows various ways of getting information about image collections programmatically:</p>
<div class="sourceCode" id="cb372"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load a Landsat 8 ImageCollection for a single path-row.</span>
<span class="va">collection</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"LANDSAT/LC08/C01/T1_TOA"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"WRS_PATH"</span>, <span class="fl">44</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"WRS_ROW"</span>, <span class="fl">34</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2014-03-01"</span>, <span class="st">"2014-08-01"</span><span class="op">)</span>
<span class="fu">ee_print</span><span class="op">(</span><span class="va">collection</span><span class="op">)</span>

<span class="co"># Get the number of images.</span>
<span class="va">count</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Count: "</span>, <span class="va">count</span><span class="op">$</span><span class="fu">getInfo</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Get the date range of images in the collection.</span>
<span class="va">range</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">reduceColumns</span><span class="op">(</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">minMax</span><span class="op">(</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"system:time_start"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">col_min</span> <span class="op">&lt;-</span> <span class="fu">eedate_to_rdate</span><span class="op">(</span><span class="va">range</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"min"</span><span class="op">)</span><span class="op">)</span>
<span class="va">col_max</span> <span class="op">&lt;-</span> <span class="fu">eedate_to_rdate</span><span class="op">(</span><span class="va">range</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"max"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Date range: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">col_min</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">col_max</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Get statistics for a property of the images in the collection.</span>
<span class="va">sunStats</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">aggregate_stats</span><span class="op">(</span><span class="st">"SUN_ELEVATION"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Sun elevation statistics: "</span><span class="op">)</span>
<span class="va">sunStats</span><span class="op">$</span><span class="fu">getInfo</span><span class="op">(</span><span class="op">)</span>

<span class="co"># Sort by a cloud cover property, get the least cloudy image.</span>
<span class="va">image</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="va">collection</span><span class="op">$</span><span class="fu">sort</span><span class="op">(</span><span class="st">"CLOUD_COVER"</span><span class="op">)</span><span class="op">$</span><span class="fu">first</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Least cloudy image: "</span><span class="op">)</span>
<span class="va">image</span><span class="op">$</span><span class="fu">getInfo</span><span class="op">(</span><span class="op">)</span>

<span class="co"># Limit the collection to the 10 most recent images.</span>
<span class="va">recent</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">sort</span><span class="op">(</span><span class="st">"system:time_start"</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="fu">limit</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Recent images: "</span><span class="op">)</span>
<span class="va">recent</span><span class="op">$</span><span class="fu">getInfo</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="filtering-an-imagecollection" class="section level2 unnumbered">
<h2>Filtering an ImageCollection<a class="anchor" aria-label="anchor" href="#filtering-an-imagecollection"><i class="fas fa-link"></i></a>
</h2>
<p>As illustrated in the <a href="">Get Started section</a> and the <a href="">ImageCollection Information section</a>, Earth Engine provides a variety of convenience methods for filtering image collections. Specifically, many common use cases are handled by <code>imageCollection$filterDate()</code>, and <code>imageCollection$filterBounds()</code>. For general purpose filtering, use <code>imageCollection$filter()</code> with an <code>ee$Filter</code> as an argument. The following example demonstrates both convenience methods and <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to identify and remove images with bad registration from an <code>ImageCollection</code>:</p>
<div class="sourceCode" id="cb373"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load Landsat 5 data, filter by date and bounds.</span>
<span class="va">collection</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"LANDSAT/LT05/C01/T2"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"1987-01-01"</span>, <span class="st">"1990-05-01"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="fl">25.8544</span>, <span class="op">-</span><span class="fl">18.08874</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Also filter the collection by the IMAGE_QUALITY property.</span>
<span class="va">filtered</span> <span class="op">&lt;-</span> <span class="va">collection</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterMetadata</span><span class="op">(</span><span class="st">"IMAGE_QUALITY"</span>, <span class="st">"equals"</span>, <span class="fl">9</span><span class="op">)</span>

<span class="co"># Create two composites to check the effect of filtering by IMAGE_QUALITY.</span>
<span class="va">badComposite</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Algorithms</span><span class="op">$</span><span class="va">Landsat</span><span class="op">$</span><span class="fu">simpleComposite</span><span class="op">(</span><span class="va">collection</span>, <span class="fl">75</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">goodComposite</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Algorithms</span><span class="op">$</span><span class="va">Landsat</span><span class="op">$</span><span class="fu">simpleComposite</span><span class="op">(</span><span class="va">filtered</span>, <span class="fl">75</span>, <span class="fl">3</span><span class="op">)</span>

<span class="co"># Display the composites.</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">setCenter</span><span class="op">(</span><span class="fl">25.8544</span>, <span class="op">-</span><span class="fl">18.08874</span>, <span class="fl">13</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">badComposite</span>,
  <span class="va">vizParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B3"</span>, <span class="st">"B2"</span>, <span class="st">"B1"</span><span class="op">)</span>,
    gain <span class="op">=</span> <span class="fl">3.5</span>
  <span class="op">)</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"bad composite"</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/chapter_05/figure_fic_bc.png" width="670" alt=""><p class="caption">Figure 12a. Bad composite</p>
</div>
<div class="sourceCode" id="cb374"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">goodComposite</span>,
  <span class="va">vizParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B3"</span>, <span class="st">"B2"</span>, <span class="st">"B1"</span><span class="op">)</span>,
    gain <span class="op">=</span> <span class="fl">3.5</span>
  <span class="op">)</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"good composite"</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/chapter_05/figure_fic_gc.png" width="670" alt=""><p class="caption">Figure 12b. Good composite</p>
</div>
</div>
<div id="mapping-over-an-imagecollection" class="section level2 unnumbered">
<h2>Mapping over an ImageCollection<a class="anchor" aria-label="anchor" href="#mapping-over-an-imagecollection"><i class="fas fa-link"></i></a>
</h2>
<p>To apply a function to every <code>Image</code> in an <code>ImageCollection</code> use <code>imageCollection$map()</code> . The only argument to <code>map()</code> is a function which takes one parameter: an <code>ee$Image</code>. For example, the following code adds a timestamp band to every image in the collection:</p>
<div class="sourceCode" id="cb375"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load a Landsat 8 collection for a single path-row.</span>
<span class="va">collection</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"LANDSAT/LC8_L1T_TOA"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"WRS_PATH"</span>, <span class="fl">44</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"WRS_ROW"</span>, <span class="fl">34</span><span class="op">)</span><span class="op">)</span>

<span class="co"># This function uses a conditional statement to return the image if</span>
<span class="co"># the solar elevation &gt; 40 degrees.  Otherwise it returns a zero image.</span>
<span class="va">conditional</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">image</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Algorithms</span><span class="op">$</span><span class="fu">If</span><span class="op">(</span>
    <span class="va">ee</span><span class="op">$</span><span class="fu">Number</span><span class="op">(</span><span class="va">image</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"SUN_ELEVATION"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">gt</span><span class="op">(</span><span class="fl">40</span><span class="op">)</span>,
    <span class="va">image</span>,
    <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
  <span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Map the function over the collection, convert to a List and print the result.</span>
<span class="fu">ee_print</span><span class="op">(</span><span class="va">collection</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="va">conditional</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Note that in the predefined function, the <code>metadata()</code> method is used to create a new <code>Image</code> from the value of a property. As discussed in the <a href="">Reducing</a> and <a href="">Compositing</a> sections, having that time band is useful for the linear modeling of change and for making composites.</p>
<p>The mapped function is limited in the operations it can perform. Specifically, it can’t modify variables outside the function; it can’t print anything; it can’t use R ‘if’ or ‘for’ statements. However, you can use <code>ee$Algorithms$If()</code> to perform conditional operations in a mapped function. For example:</p>
<div class="sourceCode" id="cb376"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load a Landsat 8 collection for a single path-row.</span>
<span class="va">collection</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"LANDSAT/LC8_L1T_TOA"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"WRS_PATH"</span>, <span class="fl">44</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"WRS_ROW"</span>, <span class="fl">34</span><span class="op">)</span><span class="op">)</span>

<span class="co"># This function uses a conditional statement to return the image if</span>
<span class="co"># the solar elevation &gt; 40 degrees.  Otherwise it returns a zero image.</span>
<span class="va">conditional</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">image</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Algorithms</span><span class="op">$</span><span class="fu">If</span><span class="op">(</span>
    <span class="va">ee</span><span class="op">$</span><span class="fu">Number</span><span class="op">(</span><span class="va">image</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"SUN_ELEVATION"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">gt</span><span class="op">(</span><span class="fl">40</span><span class="op">)</span>,
    <span class="va">image</span>,
    <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
  <span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Map the function over the collection, convert to a List and print the result.</span>
<span class="fu">ee_print</span><span class="op">(</span><span class="va">collection</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="va">conditional</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Inspect the list of images in the output ImageCollection and note that the when the condition evaluated by the <code>If()</code> algorithm is true, the output contains a constant image. Although this demonstrates a server-side conditional function (learn more about client vs. server in Earth Engine on <a href="">this page</a>, avoid <code>If()</code> in general and use filters instead.</p>
</div>
<div id="reducing-an-imagecollection" class="section level2 unnumbered">
<h2>Reducing an ImageCollection<a class="anchor" aria-label="anchor" href="#reducing-an-imagecollection"><i class="fas fa-link"></i></a>
</h2>
<p>To composite images in an <code>ImageCollection</code>, use <code>imageCollection$reduce()</code>. This will composite all the images in the collection to a single image representing, for example, the min, max, mean or standard deviation of the images. (See the <a href="">Reducers section</a> for more information about reducers). For example, to create a median value image from a collection:</p>
<div class="sourceCode" id="cb377"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load a Landsat 8 collection for a single path-row.</span>
<span class="va">collection</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"LANDSAT/LC08/C01/T1_TOA"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"WRS_PATH"</span>, <span class="fl">44</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Filter</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="st">"WRS_ROW"</span>, <span class="fl">34</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2014-01-01"</span>, <span class="st">"2015-01-01"</span><span class="op">)</span>

<span class="co"># Compute a median image and display.</span>
<span class="va">median</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">median</span><span class="op">(</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">setCenter</span><span class="op">(</span><span class="op">-</span><span class="fl">122.3578</span>, <span class="fl">37.7726</span>, <span class="fl">12</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">median</span>,
  <span class="va">vizParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B4"</span>, <span class="st">"B3"</span>, <span class="st">"B2"</span><span class="op">)</span>,
    max <span class="op">=</span> <span class="fl">0.3</span>
  <span class="op">)</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"median"</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/chapter_05/figure_ric.png" width="760" alt=""><p class="caption">Figure 13. Median value image from a collection</p>
</div>
<p>At each location in the output image, in each band, the pixel value is the median of all unmasked pixels in the input imagery (the images in the collection). In the previous example, <code><a href="https://rdrr.io/r/stats/median.html">median()</a></code> is a convenience method for the following call:</p>
<div class="sourceCode" id="cb378"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Reduce the collection with a median reducer.</span>
<span class="va">median</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">reduce</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">median</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Display the median image.</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">median</span>,
  <span class="va">vizParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B4_median"</span>, <span class="st">"B3_median"</span>, <span class="st">"B2_median"</span><span class="op">)</span>,
    max <span class="op">=</span> <span class="fl">0.3</span>
  <span class="op">)</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"also median"</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/chapter_05/figure_ric_01.png" width="670" alt=""><p class="caption">Figure 14. Median value image from a collection</p>
</div>
<p>Note that the band names differ as a result of using <code>reduce()</code> instead of the convenience method. Specifically, the names of the reducer have been appended to the band names.</p>
<p>More complex reductions are also possible using <code>reduce()</code>. For example, to compute the long term linear trend over a collection, use one of the linear regression reducers. The following code computes the linear trend of MODIS Enhanced Vegetation Index (EVI):</p>
<div class="sourceCode" id="cb379"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This function adds a band representing the image timestamp.</span>
<span class="va">addTime</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">image</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">image</span><span class="op">$</span><span class="fu">addBands</span><span class="op">(</span><span class="va">image</span><span class="op">$</span><span class="fu">metadata</span><span class="op">(</span><span class="st">"system:time_start"</span><span class="op">)</span><span class="op">$</span>
    <span class="co"># Convert milliseconds from epoch to years to aid in</span>
    <span class="co"># interpretation of the following trend calculation.</span>
    <span class="fu">divide</span><span class="op">(</span><span class="fl">1000</span> <span class="op">*</span> <span class="fl">60</span> <span class="op">*</span> <span class="fl">60</span> <span class="op">*</span> <span class="fl">24</span> <span class="op">*</span> <span class="fl">365</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Load a MODIS collection, filter to several years of 16 day mosaics,</span>
<span class="co"># and map the time band function over it.</span>
<span class="va">collection</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"MODIS/006/MYD13A1"</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">filterDate</span><span class="op">(</span><span class="st">"2004-01-01"</span>, <span class="st">"2010-10-31"</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">map</span><span class="op">(</span><span class="va">addTime</span><span class="op">)</span>

<span class="co"># Select the bands to model with the independent variable first.</span>
<span class="va">trend</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"system:time_start"</span>, <span class="st">"EVI"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span>
  <span class="co"># Compute the linear trend over time.</span>
  <span class="fu">reduce</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">linearFit</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Display the trend with increasing slopes in green, decreasing in red.</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">setCenter</span><span class="op">(</span><span class="op">-</span><span class="fl">96.943</span>, <span class="fl">39.436</span>, <span class="fl">5</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">trend</span>,
  <span class="va">vizParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    min <span class="op">=</span> <span class="fl">0</span>,
    max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fl">100</span>, <span class="fl">10000</span><span class="op">)</span>,
    bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"scale"</span>, <span class="st">"scale"</span>, <span class="st">"offset"</span><span class="op">)</span>
  <span class="op">)</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"EVI trend"</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/chapter_05/figure_ric_02.png" width="670" alt=""><p class="caption">Figure 15. Linear trend of MODIS Enhanced Vegetation Index (EVI)</p>
</div>
<p>Note that the output of the reduction in this example is a two banded image with one band for the slope of a linear regression ( <code>scale</code> ) and one band for the intercept ( <code>offset</code> ). Explore the API documentation to see a list of the reducers that are available to reduce an <code>ImageCollection</code> to a single <code>Image</code>.</p>
<div id="composites-have-no-projection" class="section level3 unnumbered">
<h3>Composites have no projection<a class="anchor" aria-label="anchor" href="#composites-have-no-projection"><i class="fas fa-link"></i></a>
</h3>
<p>Composite images created by reducing an image collection are able to produce pixels in any requested projection and therefore have no fixed output projection. Instead, composites have <a href="">the default projection</a> of WGS-84 with 1-degree resolution pixels. Composites with the default projection will be computed in whatever output projection is requested. A request occurs by displaying the composite in the Rstudio (learn about how the Rstudio sets <a href="">scale</a> and <a href="">projection</a>), or by explicitly specifying a projection/scale as in an aggregation such as <code>ReduceRegion</code> or <code>Export</code>.</p>
</div>
</div>
<div id="compositing-and-mosaicking" class="section level2 unnumbered">
<h2>Compositing and Mosaicking<a class="anchor" aria-label="anchor" href="#compositing-and-mosaicking"><i class="fas fa-link"></i></a>
</h2>
<p>In general, compositing refers to the process of combining spatially overlapping images into a single image based on an aggregation function. Mosaicking refers to the process of spatially assembling image datasets to produce a spatially continuous image. In Earth Engine, these terms are used interchangeably, though both compositing and mosaicking are supported. For example, consider the task of compositing multiple images in the same location. For example, using one National Agriculture Imagery Program (NAIP) Digital Orthophoto Quarter Quadrangle (DOQQ) at different times, the following example demonstrates making a maximum value composite:</p>
<div class="sourceCode" id="cb380"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load three NAIP quarter quads in the same location, different times.</span>
<span class="va">naip2004_2012</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"USDA/NAIP/DOQQ"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="op">-</span><span class="fl">71.08841</span>, <span class="fl">42.39823</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2004-07-01"</span>, <span class="st">"2012-12-31"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"R"</span>, <span class="st">"G"</span>, <span class="st">"B"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Temporally composite the images with a maximum value function.</span>
<span class="va">composite</span> <span class="op">&lt;-</span> <span class="va">naip2004_2012</span><span class="op">$</span><span class="fu">max</span><span class="op">(</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">setCenter</span><span class="op">(</span><span class="op">-</span><span class="fl">71.12532</span>, <span class="fl">42.3712</span>, <span class="fl">12</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">composite</span>,
  <span class="va">visParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"max value composite"</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/chapter_05/figure_cm.png" width="670" alt=""><p class="caption">Figure 16. Maxium value composite</p>
</div>
<p>Consider the need to mosaic four different DOQQs at the same time, but different locations. The following example demonstrates that using <code>imageCollection$mosaic()</code> :</p>
<div class="sourceCode" id="cb381"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load four 2012 NAIP quarter quads, different locations.</span>
<span class="va">naip2012</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"USDA/NAIP/DOQQ"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Rectangle</span><span class="op">(</span><span class="op">-</span><span class="fl">71.17965</span>, <span class="fl">42.35125</span>, <span class="op">-</span><span class="fl">71.08824</span>, <span class="fl">42.40584</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2012-01-01"</span>, <span class="st">"2012-12-31"</span><span class="op">)</span>

<span class="co"># Spatially mosaic the images in the collection and display.</span>
<span class="va">mosaic</span> <span class="op">&lt;-</span> <span class="va">naip2012</span><span class="op">$</span><span class="fu">mosaic</span><span class="op">(</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">setCenter</span><span class="op">(</span><span class="op">-</span><span class="fl">71.12532</span>, <span class="fl">42.3712</span>, <span class="fl">12</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">mosaic</span>,
  <span class="va">visParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"spatial mosaic"</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/chapter_05/figure_cm_01.png" width="670" alt=""><p class="caption">Figure 17. Spatial mosaic</p>
</div>
<p>Note that there is some overlap in the DOQQs in the previous example. The <code>mosaic()</code> method composites overlapping images according to their order in the collection (last on top). To control the source of pixels in a mosaic (or a composite), use image masks. For example, the following uses thresholds on spectral indices to mask the image data in a mosaic:</p>
<div class="sourceCode" id="cb382"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load a NAIP quarter quad, display.</span>
<span class="va">naip</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="st">"USDA/NAIP/DOQQ/m_4207148_nw_19_1_20120710"</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">setCenter</span><span class="op">(</span><span class="op">-</span><span class="fl">71.0915</span>, <span class="fl">42.3443</span>, <span class="fl">14</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">setZoom</span><span class="op">(</span><span class="va">zoom</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">naip</span>,
  <span class="va">visParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"NAIP DOQQ"</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="../images/chapter_05/figure_cm_02.png" width="670"></div>
<div class="sourceCode" id="cb383"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create the NDVI and NDWI spectral indices.</span>
<span class="va">ndvi</span> <span class="op">&lt;-</span> <span class="va">naip</span><span class="op">$</span><span class="fu">normalizedDifference</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"N"</span>, <span class="st">"R"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ndwi</span> <span class="op">&lt;-</span> <span class="va">naip</span><span class="op">$</span><span class="fu">normalizedDifference</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"G"</span>, <span class="st">"N"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Create some binary images from thresholds on the indices.</span>
<span class="co"># This threshold is designed to detect bare land.</span>
<span class="va">bare1</span> <span class="op">&lt;-</span> <span class="va">ndvi</span><span class="op">$</span><span class="fu">lt</span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span><span class="op">$</span><span class="fu">And</span><span class="op">(</span><span class="va">ndwi</span><span class="op">$</span><span class="fu">lt</span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span><span class="op">)</span>
<span class="co"># This detects bare land with lower sensitivity. It also detects shadows.</span>
<span class="va">bare2</span> <span class="op">&lt;-</span> <span class="va">ndvi</span><span class="op">$</span><span class="fu">lt</span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span><span class="op">$</span><span class="fu">And</span><span class="op">(</span><span class="va">ndwi</span><span class="op">$</span><span class="fu">lt</span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Define visualization parameters for the spectral indices.</span>
<span class="va">ndviViz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  min <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,
  max <span class="op">=</span> <span class="fl">1</span>,
  palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FF0000"</span>, <span class="st">"00FF00"</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">ndwiViz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  min <span class="op">=</span> <span class="fl">0.5</span>,
  max <span class="op">=</span> <span class="fl">1</span>,
  palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FF0000"</span>, <span class="st">"00FF00"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Mask and mosaic visualization images.  The last layer is on top.</span>
<span class="va">mosaic</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="co"># NDWI &gt; 0.5 is water.  Visualize it with a blue palette.</span>
  <span class="va">ndwi</span><span class="op">$</span><span class="fu">updateMask</span><span class="op">(</span><span class="va">ndwi</span><span class="op">$</span><span class="fu">gte</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">visualize</span><span class="op">(</span><span class="va">ndwiViz</span><span class="op">)</span>,
  <span class="co"># NDVI &gt; 0.2 is vegetation.  Visualize it with a green palette.</span>
  <span class="va">ndvi</span><span class="op">$</span><span class="fu">updateMask</span><span class="op">(</span><span class="va">ndvi</span><span class="op">$</span><span class="fu">gte</span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">visualize</span><span class="op">(</span><span class="va">ndviViz</span><span class="op">)</span>,
  <span class="co"># Visualize bare areas with shadow (bare2 but not bare1) as gray.</span>
  <span class="va">bare2</span><span class="op">$</span><span class="fu">updateMask</span><span class="op">(</span><span class="va">bare2</span><span class="op">$</span><span class="fu">And</span><span class="op">(</span><span class="va">bare1</span><span class="op">$</span><span class="fu">Not</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">visualize</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">palette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AAAAAA"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
  <span class="co"># Visualize the other bare areas as white.</span>
  <span class="va">bare1</span><span class="op">$</span><span class="fu">updateMask</span><span class="op">(</span><span class="va">bare1</span><span class="op">)</span><span class="op">$</span><span class="fu">visualize</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">palette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FFFFFF"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">mosaic</span><span class="op">(</span><span class="op">)</span>

<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">ndwi</span>,
  <span class="va">visParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"Visualization mosaic"</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/chapter_05/figure_cm_02_1.png" width="670" alt=""><p class="caption">Figure 18. National Agriculture Imagery Program (NAIP) Digital Orthophoto Quarter Quadrangle (DOQQ)</p>
</div>
<p>To make a composite which maximizes an arbitrary band in the input, use <code>imageCollection$qualityMosaic()</code>. The <code>qualityMosaic()</code> method sets each pixel in the composite based on which image in the collection has a maximum value for the specified band. For example, the following code demonstrates making a greenest pixel composite and a recent value composite:</p>
<div class="sourceCode" id="cb384"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This function masks clouds in Landsat 8 imagery.</span>
<span class="va">maskClouds</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">image</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">scored</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Algorithms</span><span class="op">$</span><span class="va">Landsat</span><span class="op">$</span><span class="fu">simpleCloudScore</span><span class="op">(</span><span class="va">image</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">image</span><span class="op">$</span><span class="fu">updateMask</span><span class="op">(</span><span class="va">scored</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cloud"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">lt</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># This function masks clouds and adds quality bands to Landsat 8 images.</span>
<span class="va">addQualityBands</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">image</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu">maskClouds</span><span class="op">(</span><span class="va">image</span><span class="op">)</span><span class="op">$</span>
    <span class="co"># NDVI</span>
    <span class="fu">addBands</span><span class="op">(</span><span class="va">image</span><span class="op">$</span><span class="fu">normalizedDifference</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B5"</span>, <span class="st">"B4"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span>
    <span class="fu">addBands</span><span class="op">(</span><span class="va">image</span><span class="op">$</span><span class="fu">metadata</span><span class="op">(</span><span class="st">"system:time_start"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Load a 2014 Landsat 8 ImageCollection.</span>
<span class="co"># Map the cloud masking and quality band function over the collection.</span>
<span class="va">collection</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"LANDSAT/LC08/C01/T1_TOA"</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">filterDate</span><span class="op">(</span><span class="st">"2014-06-01"</span>, <span class="st">"2014-12-31"</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">map</span><span class="op">(</span><span class="va">addQualityBands</span><span class="op">)</span>

<span class="co"># Create a cloud-free, most recent value composite.</span>
<span class="va">recentValueComposite</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">qualityMosaic</span><span class="op">(</span><span class="st">"system:time_start"</span><span class="op">)</span>

<span class="co"># Create a greenest pixel composite.</span>
<span class="va">greenestPixelComposite</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">qualityMosaic</span><span class="op">(</span><span class="st">"nd"</span><span class="op">)</span>

<span class="co"># Display the results.</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">setCenter</span><span class="op">(</span><span class="op">-</span><span class="fl">122.374</span>, <span class="fl">37.8239</span>, <span class="fl">12</span><span class="op">)</span> <span class="co"># San Francisco Bay</span>
<span class="va">vizParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B5"</span>, <span class="st">"B4"</span>, <span class="st">"B3"</span><span class="op">)</span>,
  min <span class="op">=</span> <span class="fl">0</span>,
  max <span class="op">=</span> <span class="fl">0.4</span>
<span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">recentValueComposite</span>,
  <span class="va">vizParams</span> <span class="op">&lt;-</span> <span class="va">vizParams</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"recent value composite"</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="../images/chapter_05/figure_cm_03.png" width="670"></div>
<div class="sourceCode" id="cb385"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span><span class="va">greenestPixelComposite</span>, <span class="va">vizParams</span>, <span class="st">"greenest pixel composite"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="../images/chapter_05/figure_cm_04.png" width="670"></div>
<div class="sourceCode" id="cb386"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Compare to a cloudy image in the collection.</span>
<span class="va">cloudy</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="st">"LANDSAT/LC08/C01/T1_TOA/LC08_044034_20140825"</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">cloudy</span>, 
  <span class="va">vizParams</span> <span class="op">&lt;-</span> <span class="va">vizParams</span>, 
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"cloudy"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="../images/chapter_05/figure_cm_05.png" width="670"></div>
<p>Use the Rstudio <a href="">Inspector tab</a> to check pixel values at different locations in the composites. Observe that the <code>system:time_start</code> band varies by location, indicating that different pixels come from different times.</p>
</div>
<div id="iterating-over-an-imagecollection" class="section level2 unnumbered">
<h2>Iterating over an ImageCollection<a class="anchor" aria-label="anchor" href="#iterating-over-an-imagecollection"><i class="fas fa-link"></i></a>
</h2>
<p>
Although <code translate="no" dir="ltr">map()</code> applies a function to every image in a collection, the
function visits every image in the collection independently. For example, suppose you
want to compute a cumulative anomaly (<i>A<sub>t</sub></i>) at time <i>t</i> from a time
series. To obtain a recursively defined series of the form <i>A<sub>t</sub> =
f(Image<sub>t</sub>, A<sub>t-1</sub>)</i>, mapping won’t work because the function
(<i>f</i>) depends on the previous result (<i>A<sub>t-1</sub></i>). For example, suppose
you want to compute a series of cumulative Normalized Difference Vegetation Index (NDVI)
anomaly images relative to a baseline. Let <i>A<sub>0</sub></i>&lt;- 0 and
<i>f(Image<sub>t</sub>, A<sub>t-1</sub>)</i>&lt;- <i>Image<sub>t</sub> + A<sub>t-1</sub></i>
where <i>A<sub>t-1</sub></i> is the cumulative anomaly up to time <i>t-1</i> and
<i>Image<sub>t</sub></i> is the anomaly at time <i>t</i>. Use
<code translate="no" dir="ltr">imageCollection.iterate()</code> to make this recursively defined
<code translate="no" dir="ltr">ImageCollection</code>. In the following example, the function
<code translate="no" dir="ltr">accumulate()</code> takes two parameters: an image in the collection, and a list
of all the previous outputs. With each call to <code translate="no" dir="ltr">iterate()</code>, the anomaly is
added to the running sum and the result is added to the list. The final result is
passed to the <code translate="no" dir="ltr">ImageCollection</code> constructor to get a new sequence of images:
</p>
<div class="sourceCode" id="cb387"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load MODIS EVI imagery.</span>
<span class="va">collection</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"MODIS/006/MYD13A1"</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"EVI"</span><span class="op">)</span>

<span class="co"># Define reference conditions from the first 10 years of data.</span>
<span class="va">reference</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2001-01-01"</span>, <span class="st">"2010-12-31"</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">sort</span><span class="op">(</span><span class="st">"system:time_start"</span>, <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># Compute the mean of the first 10 years.</span>
<span class="va">mean</span> <span class="op">&lt;-</span> <span class="va">reference</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span>

<span class="co"># Compute anomalies by subtracting the 2001-2010 mean from each image in a</span>
<span class="co"># collection of 2011-2014 images. Copy the date metadata over to the</span>
<span class="co"># computed anomaly images in the new collection.</span>
<span class="va">series</span> <span class="op">&lt;-</span> <span class="va">collection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">"2011-01-01"</span>, <span class="st">"2014-12-31"</span><span class="op">)</span><span class="op">$</span><span class="fu">map</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">image</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">image</span><span class="op">$</span><span class="fu">subtract</span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"system:time_start"</span>, <span class="va">image</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"system:time_start"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Display cumulative anomalies.</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">setCenter</span><span class="op">(</span><span class="op">-</span><span class="fl">100.811</span>, <span class="fl">40.2</span>, <span class="fl">5</span><span class="op">)</span>
<span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span>
  <span class="va">eeObject</span> <span class="op">&lt;-</span> <span class="va">series</span><span class="op">$</span><span class="fu">sum</span><span class="op">(</span><span class="op">)</span>,
  <span class="va">vizParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    min <span class="op">=</span> <span class="op">-</span><span class="fl">60000</span>,
    max <span class="op">=</span> <span class="fl">60000</span>,
    palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FF0000"</span>, <span class="st">"000000"</span>, <span class="st">"00FF00"</span><span class="op">)</span>
  <span class="op">)</span>,
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"EVI anomaly"</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="../images/chapter_05/figure_ioi.png" width="670" alt=""><p class="caption">Cumulative anomalies</p>
</div>
<div class="sourceCode" id="cb388"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get the timestamp from the most recent image in the reference collection.</span>
<span class="va">time0</span> <span class="op">&lt;-</span> <span class="va">reference</span><span class="op">$</span><span class="fu">first</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"system:time_start"</span><span class="op">)</span>

<span class="co"># Use imageCollection.iterate() to make a collection of cumulative anomaly over time.</span>
<span class="co"># The initial value for iterate() is a list of anomaly images already processed.</span>
<span class="co"># The first anomaly image in the list is just 0, with the time0 timestamp.</span>
<span class="va">first</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">List</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="co"># Rename the first band 'EVI'.</span>
  <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"system:time_start"</span>, <span class="va">time0</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"EVI"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span>

<span class="co"># This is a function to pass to Iterate().</span>
<span class="co"># As anomaly images are computed, add them to the list.</span>
<span class="va">accumulate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">image</span>, <span class="va">list</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Get the latest cumulative anomaly image from the end of the list with</span>
  <span class="co"># get(-1).  Since the type of the list argument to the function is unknown,</span>
  <span class="co"># it needs to be cast to a List.  Since the return type of get() is unknown,</span>
  <span class="co"># cast it to Image.</span>
  <span class="va">previous</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="fu">List</span><span class="op">(</span><span class="va">list</span><span class="op">)</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="co"># Add the current anomaly to make a new cumulative anomaly image.</span>
  <span class="va">added</span> <span class="op">&lt;-</span> <span class="va">image</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">previous</span><span class="op">)</span><span class="op">$</span>
    <span class="co"># Propagate metadata to the new image.</span>
    <span class="fu">set</span><span class="op">(</span><span class="st">"system:time_start"</span>, <span class="va">image</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"system:time_start"</span><span class="op">)</span><span class="op">)</span>
  <span class="co"># Return the list with the cumulative anomaly inserted.</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="fu">List</span><span class="op">(</span><span class="va">list</span><span class="op">)</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">added</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Create an ImageCollection of cumulative anomaly images by iterating.</span>
<span class="co"># Since the return type of iterate is unknown, it needs to be cast to a List.</span>
<span class="va">cumulative</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="va">ee</span><span class="op">$</span><span class="fu">List</span><span class="op">(</span><span class="va">series</span><span class="op">$</span><span class="fu">iterate</span><span class="op">(</span><span class="va">accumulate</span>, <span class="va">first</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Predefine the chart titles.</span>
<span class="va">title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  title <span class="op">=</span> <span class="st">"Cumulative EVI anomaly over time"</span>,
  hAxis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"Time"</span><span class="op">)</span>,
  vAxis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"Cumulative EVI anomaly"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Chart some interesting locations.</span>
<span class="va">pt1</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="op">-</span><span class="fl">65.544</span>, <span class="op">-</span><span class="fl">4.894</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Amazon rainforest:"</span>, <span class="va">Chart</span><span class="op">$</span><span class="va">image</span><span class="op">$</span><span class="fu">series</span><span class="op">(</span><span class="va">cumulative</span>, <span class="va">pt1</span>, <span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">first</span><span class="op">(</span><span class="op">)</span>, <span class="fl">500</span><span class="op">)</span><span class="op">$</span><span class="fu">getInfo</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">setOptions</span><span class="op">(</span><span class="va">title</span><span class="op">)</span><span class="op">)</span>

<span class="va">pt2</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="fl">116.4647</span>, <span class="fl">40.1054</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Beijing urbanization:"</span>, <span class="va">Chart</span><span class="op">$</span><span class="va">image</span><span class="op">$</span><span class="fu">series</span><span class="op">(</span><span class="va">cumulative</span>, <span class="va">pt2</span>, <span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">first</span><span class="op">(</span><span class="op">)</span>, <span class="fl">500</span><span class="op">)</span><span class="op">$</span><span class="fu">getInfo</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">setOptions</span><span class="op">(</span><span class="va">title</span><span class="op">)</span><span class="op">)</span>

<span class="va">pt3</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="op">-</span><span class="fl">110.3412</span>, <span class="fl">34.1982</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Arizona forest disturbance and recovery:"</span>, <span class="va">Chart</span><span class="op">$</span><span class="va">image</span><span class="op">$</span><span class="fu">series</span><span class="op">(</span><span class="va">cumulative</span>, <span class="va">pt3</span>, <span class="va">ee</span><span class="op">$</span><span class="va">Reducer</span><span class="op">$</span><span class="fu">first</span><span class="op">(</span><span class="op">)</span>, <span class="fl">500</span><span class="op">)</span><span class="op">$</span><span class="fu">getInfo</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">setOptions</span><span class="op">(</span><span class="va">title</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Charting these sequences indicates whether NDVI is stabilizing relative to previous disturbances or whether NDVI is trending to a new state. Learn more about charts in Earth Engine from the <a href="">Charts section</a>.</p>
<p>The iterated function is limited in the operations it can perform. Specifically, it can’t modify variables outside the function; it can’t print anything; it can’t use R ‘if’ or ‘for’ statements. Any results you wish to collect or intermediate information you wish to carry over to the next iteration must be in the function’s return value. You can use <code>ee$Algorithms$If()</code> to perform conditional operations.</p>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="image.html">Image</a></div>
<div class="next"><a href="geometry.html">Geometry</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#imagecollection">ImageCollection</a></li>
<li><a class="nav-link" href="#imagecollection-overview">ImageCollection Overview</a></li>
<li>
<a class="nav-link" href="#imagecollection-visualization">ImageCollection Visualization</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#collection-preparation">Collection preparation</a></li>
<li><a class="nav-link" href="#video-thumb">Video thumb</a></li>
<li><a class="nav-link" href="#filmstrip">Filmstrip</a></li>
<li><a class="nav-link" href="#advanced-techniques">Advanced techniques</a></li>
</ul>
</li>
<li><a class="nav-link" href="#imagecollection-information-and-metadata">ImageCollection Information and Metadata</a></li>
<li><a class="nav-link" href="#filtering-an-imagecollection">Filtering an ImageCollection</a></li>
<li><a class="nav-link" href="#mapping-over-an-imagecollection">Mapping over an ImageCollection</a></li>
<li>
<a class="nav-link" href="#reducing-an-imagecollection">Reducing an ImageCollection</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#composites-have-no-projection">Composites have no projection</a></li></ul>
</li>
<li><a class="nav-link" href="#compositing-and-mosaicking">Compositing and Mosaicking</a></li>
<li><a class="nav-link" href="#iterating-over-an-imagecollection">Iterating over an ImageCollection</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/r-earthengine/rgeebook/blob/master/chapters/05_object_methods.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/r-earthengine/rgeebook/edit/master/chapters/05_object_methods.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Earth Engine with R</strong>" was written by rgee team. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
